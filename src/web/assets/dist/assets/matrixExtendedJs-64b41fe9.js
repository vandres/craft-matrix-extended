(function(v){const{Craft:r,Garnish:p,$:d}=v;!r||!p||!d||(r.MatrixExtended=p.Base.extend({settings:{},childParent:{},entryReference:void 0,itemDrag:void 0,init:function(a){const s=this;if(this.settings=a.settings||{},this.childParent=a.childParent||{},this.entryReference=a.entryReference||void 0,!p.DisclosureMenu)return;const i=p.DisclosureMenu.prototype.show;p.DisclosureMenu.prototype.show=function(...o){s.initDisclosureMenu(this),i.apply(this,o)};const e=p.DisclosureMenu.prototype.init;if(p.DisclosureMenu.prototype.init=function(...o){e.apply(this,o),s.initAddButtonMenu(this),s.prepareEntryDropZones()},!this.settings.experimentalFeatures||!this.settings.enableDragDrop)return;const t=r.MatrixInput.prototype.init;r.MatrixInput.prototype.init=function(...o){t.apply(this,o),this.entrySort.allowDragging=()=>!1,this.entrySort.destroy(),s.prepareEntryDropZones()},r.MatrixInput.prototype.canAddMoreEntries=function(){return!this.maxEntries||this.$entriesContainer.children(":not(.matrix-extended-drop-target)").length<this.maxEntries},this.itemDrag=new p.DragDrop({activeDropTargetClass:"active",minMouseDist:10,hideDraggee:!1,moveHelperToCursor:!0,handle:o=>d(o).find("> .actions > .move, > .titlebar"),filter:()=>this.itemDrag.$targetItem.closest(".matrixblock"),dropTargets:()=>{if(!this.childParent)return[];const{entry:o,typeId:n}=this.itemDrag.$draggee.closest(".matrixblock").data();return!o.matrix||!n?[]:d(".matrix-extended-drop-target").filter((m,l)=>(this.childParent[n]||[]).includes(d(l).data("entryTypeId"))).toArray().reverse()},onDragStart:()=>{p.$bod.addClass("dragging"),this.itemDrag.$draggee.closest(".matrixblock").addClass("draggee"),this.$dropEntry=this.itemDrag.$draggee.data("entry").$container,this.$pullBlock=this.$dropEntry.closest(".matrix-field")},onDragStop:async()=>{if(this.itemDrag.$draggee.closest(".matrixblock").removeClass("draggee"),!this.$dropEntry||!this.$pullBlock)return this.itemDrag.returnHelpersToDraggees();const o=this.$dropEntry,n=this.itemDrag.$activeDropTarget;if(!o||!n)return this.itemDrag.returnHelpersToDraggees();let c,u="insertBefore";n.data("position")==="button"?(c=n.closest(".matrix-field").find("> .blocks"),u="appendTo"):c=n.next(".matrixblock");const m=this.$pullBlock,l=n.closest(".matrix-field");if(m.is(l))u==="appendTo"?o.appendTo(c):o.insertBefore(c),m.data("matrix").entrySelect.resetItemOrder();else{const h=l.data("matrix"),f=o.data("entry"),g=o.data("typeId");await this.duplicateWithNewOwner(c,u,g,f,h),h.entrySelect.resetItemOrder(),m.data("matrix").entrySelect.resetItemOrder()}this.itemDrag.returnHelpersToDraggees(),this.prepareEntryDropZones(),p.$bod.removeClass("dragging"),this.$dropEntry=void 0,this.$pullBlock=void 0}})},prepareEntryDropZones(){if(!this.settings.experimentalFeatures||!this.settings.enableDragDrop)return;const a=d(".matrix-field"),s=a.find(".matrixblock");d(".matrix-extended-drop-target").remove();for(const e of s){const t=d(e);let o=null;const n=t.data("entry");if(!n)return;const c=n.matrix;if(!c)return;o=c.settings.fieldId;const u=d('<div class="matrix-extended-drop-target" data-position="block"><div></div></div>');u.data(t.data()),u.data("entryTypeId",o),t.before(u)}const i=a.find("> .buttons");for(const e of i){const t=d(e),o=t.closest(".matrix-field").data("matrix");if(!o)continue;const n=d('<div class="matrix-extended-drop-target" data-position="button"><div></div></div>');n.data("entryTypeId",o.settings.fieldId),n.insertBefore(t)}this.itemDrag.removeAllItems(),this.itemDrag.addItems(s),p.$bod.addClass("matrix-extended-drag-drop")},initAddButtonMenu(a){if(!this.settings.experimentalFeatures||!this.settings.expandMenu)return;const{$trigger:s,$container:i}=a,e=s.parent(),t=s.closest(".matrix-field");if(!s||!i||!e.hasClass("buttons")||!t.attr("id")||s._hasMatrixExtensionButtonsInitialized)return;s.hide(),s._hasMatrixExtensionButtonsInitialized=!0;const o=d('<div class="buttons matrix-extended-buttons"></div>'),n=s.disclosureMenu().data("disclosureMenu").$container.find("button").clone().off().on("activate",async u=>{i.find("button").filter((l,h)=>d(h).data("type")===d(u.currentTarget).data("type")).trigger("activate")}),c=t.attr("id").replace(/.*fields-/,"");this.buildGroupedMenu(o,n,s,c),o.appendTo(e)},initDisclosureMenu(a){const{$trigger:s,$container:i}=a;if(!s||!i||!s.hasClass("action-btn"))return;const e=s.closest(".matrixblock");if(!e.length)return;const{typeId:t,entry:o}=e.data();if(!t||!o)return;const n=o.matrix;if(n){if(a._hasMatrixExtensionButtonsInitialized){this.checkPaste(i,n),this.checkDuplicate(i,n);return}a._hasMatrixExtensionButtonsInitialized=!0,this.addMenu(i,t,o,n)}},pasteEntry:async function(a,s,i,e){var t;if(!e.addingEntry){if(!e.canAddMoreEntries()){e.updateStatusMessage();return}e.addingEntry=!0,e.elementEditor&&await e.elementEditor.setFormValue(e.settings.baseInputName,"*");try{const{data:o}=await r.sendActionRequest("POST","matrix-extended/matrix-extended/paste-entry",{data:{fieldId:e.settings.fieldId,entryId:i.id,entryTypeId:s,ownerId:e.settings.ownerId,ownerElementType:e.settings.ownerElementType,siteId:e.settings.siteId,namespace:e.settings.namespace}}),n=d(o.blockHtml);(t=e.elementEditor)==null||t.pause(),n.insertAfter(i.$container),e.trigger("entryAdded",{$entry:n}),n.css("margin-bottom",""),r.initUiElements(n.children(".fields")),await r.appendHeadHtml(o.headHtml),await r.appendBodyHtml(o.bodyHtml),new r.MatrixInput.Entry(e,n),e.entrySort.addItems(n),e.entrySelect.addItems(n),e.updateAddEntryBtn(),n.css(e.getHiddenEntryCss(n)).velocity({opacity:1,"margin-bottom":10},"fast"),p.requestAnimationFrame(function(){var c;(c=e.elementEditor)==null||c.resume()})}catch{this.addStatusMessage(r.t("matrix-extended","There was an error pasting the entry"),"error")}e.addingEntry=!1,i.actionDisclosure.hide()}},duplicateWithNewOwner:async function(a,s,i,e,t){var o;if(!t.addingEntry){if(!t.canAddMoreEntries()){t.updateStatusMessage();return}t.addingEntry=!0,t.elementEditor&&await t.elementEditor.setFormValue(t.settings.baseInputName,"*");try{const{data:n}=await r.sendActionRequest("POST","matrix-extended/matrix-extended/duplicate-entry-with-new-owner",{data:{fieldId:t.settings.fieldId,entryId:e.id,entryTypeId:i,ownerId:t.settings.ownerId,ownerElementType:t.settings.ownerElementType,siteId:t.settings.siteId,namespace:t.settings.namespace}}),c=d(n.blockHtml);(o=t.elementEditor)==null||o.pause(),s==="appendTo"?c.appendTo(a):c.insertBefore(a),e.$container.hide(),t.trigger("entryAdded",{$entry:c}),c.css("margin-bottom",""),r.initUiElements(c.children(".fields")),await r.appendHeadHtml(n.headHtml),await r.appendBodyHtml(n.bodyHtml),new r.MatrixInput.Entry(t,c),t.entrySort.addItems(c),t.entrySelect.addItems(c),t.updateAddEntryBtn(),c.css(t.getHiddenEntryCss(c)).velocity({opacity:1,"margin-bottom":10},"fast"),p.requestAnimationFrame(function(){var u;(u=t.elementEditor)==null||u.resume(),e.selfDestruct()})}catch{this.addStatusMessage(r.t("matrix-extended","There was an error dropping the entry"),"error")}t.addingEntry=!1,e.actionDisclosure.hide()}},copyEntry:async function(a,s,i,e){try{const{data:t}=await r.sendActionRequest("POST","matrix-extended/matrix-extended/copy-entry",{data:{fieldId:e.settings.fieldId,entryId:i.id,entryTypeId:s,ownerId:e.settings.ownerId,ownerElementType:e.settings.ownerElementType,siteId:e.settings.siteId,namespace:e.settings.namespace}});this.entryReference=t.entryReference,this.checkPaste(a,e),this.checkDuplicate(a,e),await r.appendHeadHtml(t.headHtml),await r.appendBodyHtml(t.bodyHtml),this._hasMatrixExtensionButtonsInitialized,this.addStatusMessage(r.t("matrix-extended","Entry reference copied"))}catch{this.addStatusMessage(r.t("matrix-extended","There was an error copying the entry reference"),"error")}i.actionDisclosure.hide()},duplicateEntry:async function(a,s,i,e){var t;if(!e.addingEntry){if(!e.canAddMoreEntries()){e.updateStatusMessage();return}e.addingEntry=!0,e.elementEditor&&await e.elementEditor.setFormValue(e.settings.baseInputName,"*");try{const{data:o}=await r.sendActionRequest("POST","matrix-extended/matrix-extended/duplicate-entry",{data:{fieldId:e.settings.fieldId,entryId:i.id,entryTypeId:s,ownerId:e.settings.ownerId,ownerElementType:e.settings.ownerElementType,siteId:e.settings.siteId,namespace:e.settings.namespace}}),n=d(o.blockHtml);(t=e.elementEditor)==null||t.pause(),n.insertAfter(i.$container),e.trigger("entryAdded",{$entry:n}),n.css("margin-bottom",""),r.initUiElements(n.children(".fields")),await r.appendHeadHtml(o.headHtml),await r.appendBodyHtml(o.bodyHtml),new r.MatrixInput.Entry(e,n),e.entrySort.addItems(n),e.entrySelect.addItems(n),e.updateAddEntryBtn(),n.css(e.getHiddenEntryCss(n)).velocity({opacity:1,"margin-bottom":10},"fast"),p.requestAnimationFrame(function(){var c;(c=e.elementEditor)==null||c.resume()})}catch{this.addStatusMessage(r.t("matrix-extended","There was an error duplicating the entry"),"error")}e.addingEntry=!1,i.actionDisclosure.hide()}},addMenu:function(a,s,i,e){const t=d('<ul class="matrix-extended"></ul>'),o=d('<hr class="padded">');this.addAddBlockButton(t,s,i,e),this.addDuplicateButton(t,s,i,e),this.addCopyButton(t,s,i,e),this.addPasteButton(t,s,i,e),this.addDeleteButton(t,i),this.checkPaste(t,e),this.checkDuplicate(t,e),t.insertBefore(a.find("ul").eq(0)),o.insertAfter(t)},addPasteButton:function(a,s,i,e){if(!this.settings.experimentalFeatures)return;const t=d(`<li>
            <button class="menu-item" data-action="paste" tabindex="0">
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M104.6 48H64C28.7 48 0 76.7 0 112V384c0 35.3 28.7 64 64 64h96V400H64c-8.8 0-16-7.2-16-16V112c0-8.8 7.2-16 16-16H80c0 17.7 14.3 32 32 32h72.4C202 108.4 227.6 96 256 96h62c-7.1-27.6-32.2-48-62-48H215.4C211.6 20.9 188.2 0 160 0s-51.6 20.9-55.4 48zM144 56a16 16 0 1 1 32 0 16 16 0 1 1 -32 0zM448 464H256c-8.8 0-16-7.2-16-16V192c0-8.8 7.2-16 16-16l140.1 0L464 243.9V448c0 8.8-7.2 16-16 16zM256 512H448c35.3 0 64-28.7 64-64V243.9c0-12.7-5.1-24.9-14.1-33.9l-67.9-67.9c-9-9-21.2-14.1-33.9-14.1H256c-35.3 0-64 28.7-64 64V448c0 35.3 28.7 64 64 64z"/></svg>
                        </span><span class="menu-item-label">${r.t("matrix-extended","Paste")}</span>
                    </button>
                </li>`);a.append(t),t.find("button").on("click",()=>{this.pasteEntry(a,s,i,e)})},addAddBlockButton:function(a,s,i,e){if(!this.settings.experimentalFeatures||!e.$addEntryMenuBtn.length)return;const t=d(`<li>
                    <button class="menu-item" data-action="add-block" tabindex="0">
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M64 80c-8.8 0-16 7.2-16 16V416c0 8.8 7.2 16 16 16H384c8.8 0 16-7.2 16-16V96c0-8.8-7.2-16-16-16H64zM0 96C0 60.7 28.7 32 64 32H384c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM200 344V280H136c-13.3 0-24-10.7-24-24s10.7-24 24-24h64V168c0-13.3 10.7-24 24-24s24 10.7 24 24v64h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H248v64c0 13.3-10.7 24-24 24s-24-10.7-24-24z"/></svg>
                        </span><span class="menu-item-label">${r.t("matrix-extended","Add block above")}</span>
                    </button>
                </li>`);a.append(t),t.find("button").on("click",()=>{const o=e.settings.namespace?e.id.replace(/.*fields-/,""):e.id;d(".matrix-extended-buttons-above").remove(),d(`#matrix-extended-menu-${o}-all`).remove();const n=d('<div class="buttons matrix-extended-buttons matrix-extended-buttons-above"></div>'),c=e.$addEntryMenuBtn.data("disclosureMenu").$container.find("button").clone().off(),u=r.ui.createButton({label:e.$addEntryMenuBtn.find(".label").text(),spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${o}-all`),m=d(`<div class="menu menu--disclosure" id="matrix-extended-menu-${o}-all">`),l=d("<ul></ul>");m.append(l),d(document.body).append(m);const h=new p.DisclosureMenu(u);for(const f of c){const g=d("<li></li>"),y=d(f);g.append(y),l.append(g)}if(c.on("activate",async f=>{u.addClass("loading");try{await e.addEntry(d(f.currentTarget).data("type"),i.$container)}finally{h.hide(),u.remove(),m.remove(),n.remove()}}),this.settings.expandMenu){const g=u.data("disclosureMenu").$container.find("button").clone(!0,!0);this.buildGroupedMenu(n,g,u,o)}else n.append(u);n.insertBefore(i.$container),i.actionDisclosure.hide()})},addCopyButton:function(a,s,i,e){if(!this.settings.experimentalFeatures)return;const t=d(`<li>
                    <button class="menu-item" data-action="copy" tabindex="0">
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M280 64h40c35.3 0 64 28.7 64 64V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128C0 92.7 28.7 64 64 64h40 9.6C121 27.5 153.3 0 192 0s71 27.5 78.4 64H280zM64 112c-8.8 0-16 7.2-16 16V448c0 8.8 7.2 16 16 16H320c8.8 0 16-7.2 16-16V128c0-8.8-7.2-16-16-16H304v24c0 13.3-10.7 24-24 24H192 104c-13.3 0-24-10.7-24-24V112H64zm128-8a24 24 0 1 0 0-48 24 24 0 1 0 0 48z"/></svg>
                        </span><span class="menu-item-label">${r.t("matrix-extended","Copy")}</span>
                    </button>
                </li>`);a.append(t),t.find("button").on("click",()=>{this.copyEntry(a,s,i,e)})},addDuplicateButton:function(a,s,i,e){const t=d(`<li>
                <button class="menu-item" data-action="duplicate" tabindex="0">
                    <span class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M64 464H288c8.8 0 16-7.2 16-16V384h48v64c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V224c0-35.3 28.7-64 64-64h64v48H64c-8.8 0-16 7.2-16 16V448c0 8.8 7.2 16 16 16zM224 304H448c8.8 0 16-7.2 16-16V64c0-8.8-7.2-16-16-16H224c-8.8 0-16 7.2-16 16V288c0 8.8 7.2 16 16 16zm-64-16V64c0-35.3 28.7-64 64-64H448c35.3 0 64 28.7 64 64V288c0 35.3-28.7 64-64 64H224c-35.3 0-64-28.7-64-64z"/></svg>
                    </span><span class="menu-item-label">${r.t("matrix-extended","Duplicate")}</span>
                </button>
            </li>`);a.append(t),t.find("button").on("click",()=>{this.duplicateEntry(a,s,i,e)})},addDeleteButton:function(a,s){const i=d(`<li>
                <button class="menu-item error" data-action="delete" tabindex="0">
                    <span class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>
                    </span><span class="menu-item-label">${r.t("matrix-extended","Delete")}</span>
                </button>
            </li>`);a.append(i),i.find("button").on("click",function(){s.selfDestruct(),s.actionDisclosure.hide()})},buildGroupedMenu:function(a,s,i,e){let t=s;if(!this.settings.fields){const l=d('<div class="btngroup matrix-extended-btngroup"></div>');t.first().addClass("add icon"),t.addClass("btn dashed"),l.append(t),a.append(l);return}if(!this.settings.fields[e]){const l=d('<div class="btngroup matrix-extended-btngroup"></div>');t.first().addClass("add icon"),t.addClass("btn dashed"),l.append(t),a.append(l);return}const o=this.settings.fields[e];for(const[l,h]of Object.entries(o.groups)){if(d(`matrix-extended-menu-${e}-${l}`).length)continue;const f=r.ui.createButton({label:h.label,spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${e}-${l}`).appendTo(a),g=d(`<div class="menu menu--disclosure" id="matrix-extended-menu-${e}-${l}">`),y=d("<ul></ul>");g.append(y),d(document.body).append(g);const E=new p.DisclosureMenu(f);for(const b of h.types){const x=d("<li></li>"),w=s.filter((I,$)=>d($).data("type")===b);if(t=t.filter((I,$)=>d($).data("type")!==b),!w.length){console.warn(`Type ${b} not found in group ${e}`);continue}x.append(w),y.append(x),w.on("activate",()=>E.hide())}}if(!t.length)return;if(this.settings.expandUngrouped){const l=d('<div class="btngroup matrix-extended-btngroup"></div>');t.first().addClass("add icon"),t.addClass("btn dashed"),l.append(t),this.settings.ungroupedPosition==="end"?a.append(l):a.prepend(l);return}const n=r.ui.createButton({label:i.find(".label").text(),spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${e}-others`);this.settings.ungroupedPosition==="end"?n.appendTo(a):n.prependTo(a);const c=d(`<div class="menu menu--disclosure" id="matrix-extended-menu-${e}-others">`),u=d("<ul></ul>");c.append(u),d(document.body).append(c);const m=new p.DisclosureMenu(n);for(const l of t){const h=d("<li></li>"),f=d(l);h.append(f),u.append(h),f.on("activate",()=>m.hide())}},checkDuplicate:function(a,s){const i=a.find('button[data-action="duplicate"]');i.disable();const e=i.parent();if(e.attr("title",""),!s.canAddMoreEntries()){e.attr("title",r.t("matrix-extended","No more entries can be added."));return}i.enable()},checkPaste:function(a,s){const i=a.find('button[data-action="paste"]');i.disable();const e=i.parent();if(e.attr("title",""),!this.entryReference||!this.entryReference.entryTypeId){e.attr("title",r.t("matrix-extended","There is nothing to paste."));return}if(!this.childParent){e.attr("title",r.t("matrix-extended","The copied entry is not allowed here."));return}if(!s.canAddMoreEntries()){e.attr("title",r.t("matrix-extended","No more entries can be added."));return}if(!(this.childParent[this.entryReference.entryTypeId]||[]).includes(s.settings.fieldId)){e.attr("title",r.t("matrix-extended","The copied entry is not allowed here."));return}i.enable()},addStatusMessage:function(a,s="notice"){s==="notice"&&r.cp.displayNotice(a),s==="error"&&r.cp.displayError(a)}}))})(window);
//# sourceMappingURL=matrixExtendedJs-64b41fe9.js.map
