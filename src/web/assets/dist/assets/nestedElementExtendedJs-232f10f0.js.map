{"version":3,"file":"nestedElementExtendedJs-232f10f0.js","sources":["../../../../../static/src/js/nestedElementExtended.ts"],"sourcesContent":["(function (window: any) {\n    const {Craft, Garnish, $} = window;\n    if (!Craft || !Garnish || !$) {\n        return;\n    }\n\n    /**\n     * @see https://github.com/craftcms/cms/blob/5.x/src/web/assets/cp/src/js/NestedElementManager.js\n     */\n    Craft.NestedElementExtended = Garnish.Base.extend({\n        settings: {}, childParent: {}, entryReference: undefined,\n\n        init: function (config: { settings: any, childParent: any, entryReference: any }) {\n            const self = this;\n\n            this.settings = config.settings || {};\n            this.childParent = config.childParent || {};\n            this.entryReference = config.entryReference || undefined;\n\n            if (!Garnish.DisclosureMenu || !Craft.NestedElementManager) {\n                return;\n            }\n\n            const nestedInitFn = Craft.NestedElementManager.prototype.init;\n            Craft.NestedElementManager.prototype.init = function (...args: any[]) {\n                nestedInitFn.apply(this, args);\n                console.log('NestedElementExtended');\n            };\n\n            const disclosureMenuShowFn = Garnish.DisclosureMenu.prototype.show;\n            Garnish.DisclosureMenu.prototype.show = function (...args: any[]) {\n                self.initDisclosureMenu(this);\n                disclosureMenuShowFn.apply(this, args);\n            };\n        },\n\n        initDisclosureMenu(disclosureMenu: any) {\n            if (!this.settings.experimentalFeatures) {\n                return;\n            }\n\n            const {$trigger, $container} = disclosureMenu;\n            if (!$trigger || !$container || !$trigger.hasClass('action-btn')) {\n                return;\n            }\n\n            const $element = $trigger.closest('.card-actions').parent('.card-actions-container').parent('.card');\n            if (!$element.length) {\n                return;\n            }\n\n            const {typeId, id} = $element.data();\n            if (!typeId || !id) {\n                return;\n            }\n\n            const $parent = $element.closest('.nested-element-cards');\n            const nem = $parent.data('nestedElementManager');\n            if (!nem) {\n                return;\n            }\n\n            if (nem.settings.mode !== 'cards' || !nem.settings.canCreate) {\n                return;\n            }\n\n            if (disclosureMenu._hasNestedElementExtensionButtonsInitialized) {\n                // this.checkPaste($container, matrix);\n                this.checkDuplicate($container, nem);\n                // this.checkAdd($container, matrix);\n                return;\n            }\n            disclosureMenu._hasNestedElementExtensionButtonsInitialized = true;\n\n            this.addMenu($container, typeId, $element, nem);\n        },\n\n        addMenu: function ($container: any, typeId: any, $element: any, nem: any) {\n            const $menu = $('<ul class=\"matrix-extended\"></ul>');\n            const $hr = $('<hr class=\"padded\">');\n\n            // this.addAddBlockButton($menu, typeId, entry, matrix);\n            this.addDuplicateButton($container, $menu, typeId, $element, nem);\n            // this.addCopyButton($menu, typeId, entry, matrix);\n            // this.addPasteButton($menu, typeId, entry, matrix);\n            // this.addDeleteButton($menu, entry);\n\n            $menu.insertBefore($container.find('ul').eq(0));\n            $hr.insertAfter($menu);\n\n            // this.checkPaste($menu, matrix);\n            this.checkDuplicate($container, nem);\n            // this.checkAdd($menu, matrix);\n        },\n\n        addDuplicateButton: function ($container: any, $menu: any, typeId: any, $element: any, nem: any) {\n            const $duplicateButton = $(`<li>\n                <button class=\"menu-item\" data-action=\"duplicate\" tabindex=\"0\">\n                    <span class=\"icon\">\n                        <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d=\"M64 464H288c8.8 0 16-7.2 16-16V384h48v64c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V224c0-35.3 28.7-64 64-64h64v48H64c-8.8 0-16 7.2-16 16V448c0 8.8 7.2 16 16 16zM224 304H448c8.8 0 16-7.2 16-16V64c0-8.8-7.2-16-16-16H224c-8.8 0-16 7.2-16 16V288c0 8.8 7.2 16 16 16zm-64-16V64c0-35.3 28.7-64 64-64H448c35.3 0 64 28.7 64 64V288c0 35.3-28.7 64-64 64H224c-35.3 0-64-28.7-64-64z\"/></svg>\n                    </span><span class=\"menu-item-label\">${Craft.t('matrix-extended', 'Duplicate')}</span>\n                </button>\n            </li>`);\n            $menu.append($duplicateButton);\n\n            $duplicateButton.find('button').on('click', () => {\n                this.duplicateEntry($container, $menu, typeId, $element, nem);\n            });\n        },\n\n        duplicateEntry: async function ($container: any, $menu: any, typeId: any, $element: any, nem: any) {\n            if (!nem.canCreate()) {\n                return;\n            }\n\n            try {\n                await nem.markAsDirty();\n\n                const {data} = await Craft.sendActionRequest('POST', 'matrix-extended/nested-element-extended/duplicate-entry', {\n                    data: {\n                        fieldId: $element.data().fieldId,\n                        entryId: $element.data().id,\n                        entryTypeId: typeId,\n                        ownerId: nem.settings.ownerId,\n                        ownerElementType: nem.settings.ownerElementType,\n                        siteId: nem.settings.ownerSiteId,\n                    },\n                });\n\n                await this.addElementCard(data, nem, $element.data('id'));\n            } catch (error) {\n                this.addStatusMessage(Craft.t('matrix-extended', 'There was an error duplicating the entry'), 'error');\n            }\n\n            $container.data('disclosureMenu').hide();\n        },\n\n        checkDuplicate: function ($container: any, nem: any) {\n            const $duplicateButton = $container.find('button[data-action=\"duplicate\"]');\n            $duplicateButton.disable();\n            const $parent = $duplicateButton.parent();\n            $parent.attr('title', '');\n\n            if (!nem.canCreate()) {\n                $parent.attr('title', Craft.t('matrix-extended', 'No more entries can be added.'));\n                return;\n            }\n\n            $duplicateButton.enable();\n        },\n\n        /**\n         * Copy of original method, to allow custom position in the DOM\n         *\n         * @see NestedElementManager.addElementCard(element)\n         */\n        async addElementCard(element: any, nem: any, insertAfter: number) {\n            if (nem.$createBtn) {\n                nem.$createBtn.addClass('loading');\n            }\n\n            let response;\n            try {\n                response = await Craft.sendActionRequest(\n                    'POST',\n                    'app/render-elements',\n                    {\n                        data: {\n                            elements: [\n                                {\n                                    type: nem.elementType,\n                                    id: element.id,\n                                    siteId: element.siteId,\n                                    instances: [\n                                        {\n                                            context: 'field',\n                                            ui: 'card',\n                                            sortable: nem.settings.sortable,\n                                            showActionMenu: true,\n                                        },\n                                    ],\n                                },\n                            ],\n                        },\n                    }\n                );\n            } catch (e: any) {\n                Craft.cp.displayError(e?.response?.data?.message);\n                throw e?.response?.data?.message ?? e;\n            } finally {\n                if (nem.$createBtn) {\n                    nem.$createBtn.removeClass('loading');\n                }\n            }\n\n            if (!nem.$elements) {\n                nem.initCards();\n            }\n\n            const $li = $('<li/>');\n            const $card = $(response.data.elements[element.id][0]).appendTo($li);\n            nem.$elements.find(`[data-id=\"${insertAfter}\"`).parent().after($li);\n            nem.initElement($card);\n            await Craft.appendHeadHtml(response.data.headHtml);\n            await Craft.appendBodyHtml(response.data.bodyHtml);\n            Craft.cp.elementThumbLoader.load($card);\n            nem.updateCreateBtn();\n\n            return $card;\n        },\n\n        addStatusMessage: function (message: string, type: 'notice' | 'error' = 'notice') {\n            if (type === 'notice') {\n                Craft.cp.displayNotice(message);\n            }\n\n            if (type === 'error') {\n                Craft.cp.displayError(message);\n            }\n        }\n    });\n})(window);\n"],"names":["window","Craft","Garnish","$","config","self","nestedInitFn","args","disclosureMenuShowFn","disclosureMenu","$trigger","$container","$element","typeId","id","nem","$menu","$hr","$duplicateButton","data","$parent","element","insertAfter","_a","_b","_c","_d","response","e","$li","$card","message","type"],"mappings":"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"}