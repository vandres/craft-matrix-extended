(function(D){const{Craft:c,Garnish:m,$:e}=D;!c||!m||!e||(c.MatrixExtended=m.Base.extend({settings:{},childParent:{},helper:void 0,itemDrag:void 0,init:function(i,r){const d=this;if(this.settings=i.settings||{},this.childParent=i.childParent||{},this.helper=r,!m.DisclosureMenu||!c.MatrixInput)return;const n=m.DisclosureMenu.prototype.show;m.DisclosureMenu.prototype.show=function(...o){d.initDisclosureMenu(this),n.apply(this,o)};const t=m.DisclosureMenu.prototype.init;m.DisclosureMenu.prototype.init=function(...o){t.apply(this,o),d.initAddButtonMenu(this),d.prepareEntryDropZones()};const l=c.MatrixInput.prototype.updateAddEntryBtn;if(c.MatrixInput.prototype.updateAddEntryBtn=function(...o){l.apply(this,o),d.checkAddBtn(this)},!this.settings.enableDragDrop)return;const s=c.MatrixInput.prototype.init;c.MatrixInput.prototype.init=function(...o){s.apply(this,o),this.entrySort.allowDragging=()=>!1,this.entrySort.destroy(),d.prepareEntryDropZones()},c.MatrixInput.prototype.canAddMoreEntries=function(){return!this.maxEntries||this.$entriesContainer.children(":not(.matrix-extended-drop-target):not(.matrix-extended-buttons)").length<this.maxEntries};const g=c.MatrixInput.prototype.canPaste;c.MatrixInput.prototype.canPaste=function(o){return o!=null&&o.length?g.apply(this,[o]):!1};const u=c.MatrixInput.prototype.updatePasteBtn;c.MatrixInput.prototype.updatePasteBtn=function(o){o=o||c.cp.getCopiedElements(),u.apply(this,[o])};const h=e(".matrix-field").find(".matrixblock");for(const o of h){const a=e(o);a.find("> .actions > .move-btn").remove(),a.find("> .actions").append('<div class="chromeless small move"><div class="inline-flex"><div class="cp-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" focusable="false" aria-hidden="true"><path d="M71.3 295.6c-21.9-21.9-21.9-57.3 0-79.2s57.3-21.9 79.2 0 21.9 57.3 0 79.2s-57.4 21.9-79.2 0zM184.4 182.5c-21.9-21.9-21.9-57.3 0-79.2s57.3-21.9 79.2 0 21.9 57.3 0 79.2-57.3 21.8-79.2 0zm0 147c21.9-21.9 57.3-21.9 79.2 0s21.9 57.3 0 79.2s-57.3 21.9-79.2 0c-21.9-21.8-21.9-57.3 0-79.2zM297.5 216.4c21.9-21.9 57.3-21.9 79.2 0s21.9 57.3 0 79.2s-57.3 21.9-79.2 0c-21.8-21.9-21.8-57.3 0-79.2z"></path></svg></div></div></div>')}this.itemDrag=new m.DragDrop({activeDropTargetClass:"active",minMouseDist:10,hideDraggee:!1,moveHelperToCursor:!0,handle:o=>e(o).find("> .actions > .move, > .titlebar"),filter:()=>this.itemDrag.$targetItem.closest(".matrixblock"),dropTargets:()=>{if(!this.childParent)return[];const{entry:o,typeId:a}=this.itemDrag.$draggee.closest(".matrixblock").data();return!o.matrix||!a?[]:e(".matrix-extended-drop-target").filter(($,x)=>(this.childParent[a]||[]).includes(e(x).data("entryTypeId"))).toArray().reverse()},onDragStart:()=>{m.$bod.addClass("dragging"),this.itemDrag.$draggee.closest(".matrixblock").addClass("draggee"),this.$dropEntry=this.itemDrag.$draggee.data("entry").$container,this.$pullBlock=this.$dropEntry.closest(".matrix-field")},onDragStop:async()=>{if(this.itemDrag.$draggee.closest(".matrixblock").removeClass("draggee"),m.$bod.removeClass("dragging"),!this.$dropEntry||!this.$pullBlock)return this.itemDrag.returnHelpersToDraggees();const o=this.$dropEntry,a=this.itemDrag.$activeDropTarget;if(!o||!a)return this.itemDrag.returnHelpersToDraggees();let f,b="insertBefore";a.data("position")==="button"?(f=a.closest(".matrix-field").find("> .blocks"),b="appendTo"):f=a.next(".matrixblock");const $=this.$pullBlock,x=a.closest(".matrix-field");if($.is(x))b==="appendTo"?o.appendTo(f):o.insertBefore(f),$.data("matrix").entrySelect.resetItemOrder();else{const B=x.data("matrix"),y=$.data("matrix"),M=o.data("entry"),v=o.data("typeId");await this.duplicateWithNewOwner(f,b,v,M,B,y)}this.itemDrag.returnHelpersToDraggees(),this.prepareEntryDropZones(),this.$dropEntry=void 0,this.$pullBlock=void 0}})},prepareEntryDropZones(){if(!this.settings.experimentalFeatures||!this.settings.enableDragDrop)return;const i=e(".matrix-field"),r=i.find(".matrixblock");e(".matrix-extended-drop-target").remove();for(const n of r){const t=e(n);let l=null;const s=t.data("entry");if(!s)return;const g=s.matrix;if(!g)return;l=g.settings.fieldId;const u=e('<div class="matrix-extended-drop-target" data-position="block"><div></div></div>');u.data(t.data()),u.data("entryTypeId",l),t.before(u)}const d=i.find("> .buttons");for(const n of d){const t=e(n),l=t.closest(".matrix-field").data("matrix");if(!l)continue;const s=e('<div class="matrix-extended-drop-target" data-position="button"><div></div></div>');s.data("entryTypeId",l.settings.fieldId),s.insertBefore(t)}this.itemDrag.removeAllItems(),this.itemDrag.addItems(r),m.$bod.addClass("matrix-extended-drag-drop")},initAddButtonMenu(i){if(!this.settings.expandMenu)return;const{$trigger:r,$container:d}=i,n=r.parent(),l=r.closest(".buttons").parent(".matrix-field");if(!r||!d||!n.hasClass("buttons")||!l.attr("id")||r._hasMatrixExtensionButtonsInitialized)return;r.hide(),r._hasMatrixExtensionButtonsInitialized=!0;const s=e('<div class="buttons matrix-extended-buttons"></div>'),g=r.disclosureMenu().data("disclosureMenu").$container.find("button").clone().off().on("activate",async p=>{d.find("button").filter((o,a)=>e(a).data("type")===e(p.currentTarget).data("type")).trigger("activate")}),u=l.attr("id");this.buildGroupedMenu(s,g,r,u),s.appendTo(n)},initDisclosureMenu(i){const{$trigger:r,$container:d}=i;if(!r||!d||!r.hasClass("action-btn"))return;const n=r.closest(".actions").parent(".matrixblock");if(!n.length)return;const{typeId:t,entry:l}=n.data();if(!t||!l)return;const s=l.matrix;if(s){if(i._hasMatrixExtensionButtonsInitialized){this.checkAdd(d,s);return}i._hasMatrixExtensionButtonsInitialized=!0,this.addMenu(d,t,l,s)}},duplicateWithNewOwner:async function(i,r,d,n,t,l){var s;if(!t.addingEntry){if(!t.canAddMoreEntries()){t.updateStatusMessage();return}t.addingEntry=!0,t.elementEditor&&await t.elementEditor.setFormValue(t.settings.baseInputName,"*");try{const g=t.elementEditor.getDraftElementId(n.id),{data:u}=await c.sendActionRequest("POST","matrix-extended/matrix-extended/duplicate-entry-with-new-owner",{data:{fieldId:t.settings.fieldId,entryId:g,entryTypeId:d,ownerId:t.settings.ownerId,ownerElementType:t.settings.ownerElementType,siteId:t.settings.siteId,namespace:t.settings.namespace,staticEntries:t.settings.staticEntries}}),p=e(u.blockHtml);(s=t.elementEditor)==null||s.pause(),r==="appendTo"?p.appendTo(i):p.insertBefore(i),n.$container.hide(),t.trigger("entryAdded",{$entry:p}),p.css("margin-bottom",""),c.initUiElements(p.children(".fields")),await c.appendHeadHtml(u.headHtml),await c.appendBodyHtml(u.bodyHtml),new c.MatrixInput.Entry(t,p),t.entrySort.addItems(p),t.entrySelect.addItems(p),t.updateAddEntryBtn(),p.css(t.getHiddenEntryCss(p)).velocity({opacity:1,"margin-bottom":10},"fast"),m.requestAnimationFrame(function(){var h;(h=t.elementEditor)==null||h.resume(),n.selfDestruct()})}catch{this.addStatusMessage(c.t("matrix-extended","There was an error dropping the entry"),"error")}t.addingEntry=!1,n.actionDisclosure.hide()}},addMenu:function(i,r,d,n){const t=e('<ul class="matrix-extended"></ul>'),l=e('<hr class="padded">');if(this.addAddBlockButton(t,r,d,n),this.checkAdd(t,n),t.insertBefore(i.find("ul").eq(0)),l.insertAfter(t),this.settings.removeEntryTypesFromDiscloseMenu){const s=i.find('[data-action="add"]').parent().parent();s.prev().remove(),s.remove()}},addAddBlockButton:function(i,r,d,n){if(!this.settings.enableAddBlockAbove||!n.$addEntryMenuBtn.length&&!n.$addEntryBtn.length)return;const t=e(`<li>
                    <button class="menu-item" data-action="add-block" tabindex="0">
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M64 80c-8.8 0-16 7.2-16 16V416c0 8.8 7.2 16 16 16H384c8.8 0 16-7.2 16-16V96c0-8.8-7.2-16-16-16H64zM0 96C0 60.7 28.7 32 64 32H384c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM200 344V280H136c-13.3 0-24-10.7-24-24s10.7-24 24-24h64V168c0-13.3 10.7-24 24-24s24 10.7 24 24v64h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H248v64c0 13.3-10.7 24-24 24s-24-10.7-24-24z"/></svg>
                        </span><span class="menu-item-label">${c.t("matrix-extended","Add block above")}</span>
                    </button>
                </li>`);i.append(t),t.find("button").on("click",()=>{const l=n.id;e(".matrix-extended-buttons-above").remove(),e(`#matrix-extended-menu-${l}-all`).remove();const s=e('<div class="buttons matrix-extended-buttons matrix-extended-buttons-above"></div>'),g=n.$addEntryMenuBtn.length?n.$addEntryMenuBtn.data("disclosureMenu").$container.find("button").clone().off():n.$addEntryBtn.clone().off(),u=c.ui.createButton({label:n.$addEntryMenuBtn.find(".label").text(),spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${l}-all`),p=e(`<div class="menu menu--disclosure" id="matrix-extended-menu-${l}-all">`),h=e("<ul></ul>");p.append(h),e(document.body).append(p);const o=new m.DisclosureMenu(u);for(const a of g){const f=e("<li></li>"),b=e(a);f.append(b),h.append(f)}if(g.on("activate",async a=>{u.addClass("loading");try{await n.addEntry(e(a.currentTarget).data("type"),d.$container[0].checkVisibility()?d.$container:void 0)}finally{o.hide(),u.remove(),p.remove(),s.remove()}}),this.settings.expandMenu){const f=u.data("disclosureMenu").$container.find("button").clone(!0,!0);this.buildGroupedMenu(s,f,u,l,!0),n.updatePasteBtn()}else s.append(u);s.insertBefore(d.$container),d.actionDisclosure.hide()})},buildGroupedMenu:function(i,r,d,n,t=!1){const l=n.replace(/.*fields-/,"");let s=r;if(!this.settings.fields){const a=e('<div class="btngroup matrix-extended-btngroup"></div>');s.first().addClass("add icon"),s.addClass("btn dashed"),a.append(s),i.append(a);return}if(!this.settings.fields[l]){const a=e('<div class="btngroup matrix-extended-btngroup"></div>');s.first().addClass("add icon"),s.addClass("btn dashed"),a.append(s),i.append(a);return}const g=this.settings.fields[l];g.oneLiner&&i.addClass("one-line");for(const[a,f]of Object.entries(g.groups)){e(`#matrix-extended-menu-${n}-${a}${t?"-above":""}`).remove();const b=c.ui.createButton({label:f.label,spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${n}-${a}${t?"-above":""}`).appendTo(i),$=e(`<div class="menu menu--disclosure" id="matrix-extended-menu-${n}-${a}${t?"-above":""}">`),x=e("<ul></ul>");$.append(x),e(document.body).append($);const B=new m.DisclosureMenu(b);for(const y of f.types){const M=e("<li></li>"),v=r.filter((w,E)=>e(E).data("type")===y);if(s=s.filter((w,E)=>e(E).data("type")!==y),!v.length){console.warn(`Type ${y} not found in group ${n}`);continue}M.append(v),x.append(M),v.on("activate",()=>{if(!t){B.hide();return}$.remove(),B.destroy()})}}if(!s.length)return;if(this.settings.expandUngrouped){const a=e('<div class="btngroup matrix-extended-btngroup"></div>');switch(s.first().addClass("add icon"),s.addClass("btn dashed"),a.append(s),this.settings.ungroupedPosition){case"start":i.prepend(a);break;case"end":i.append(a);break}return}e(`#matrix-extended-menu-${n}-others${t?"-above":""}`).remove();const u=c.ui.createButton({label:d.find(".label").text(),spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${n}-others${t?"-above":""}`);switch(this.settings.ungroupedPosition){case"start":u.prependTo(i);break;case"end":u.appendTo(i);break}const p=e(`<div class="menu menu--disclosure" id="matrix-extended-menu-${n}-others${t?"-above":""}">`),h=e("<ul></ul>");p.append(h),e(document.body).append(p);const o=new m.DisclosureMenu(u);for(const a of s){const f=e("<li></li>"),b=e(a);f.append(b),h.append(f),b.on("activate",()=>{if(!t){o.hide();return}p.remove(),o.destroy()})}},checkAdd:function(i,r){const d=i.find('button[data-action="add-block"]');d.disable();const n=d.parent();if(n.attr("title",""),!r.canAddMoreEntries()){n.attr("title",c.t("matrix-extended","No more entries can be added."));return}d.enable()},checkAddBtn:function(i){if(!this.settings.expandMenu)return;const r=i.$container.find("> .blocks > .matrix-extended-buttons, > .buttons > .matrix-extended-buttons").find("button");r.disable();const d=r.parent();if(d.attr("title",""),!i.canAddMoreEntries()){d.attr("title",c.t("matrix-extended","No more entries can be added."));return}r.enable()},addStatusMessage:function(i,r="notice"){r==="notice"&&c.cp.displayNotice(i),r==="error"&&c.cp.displayError(i)}}))})(window);
//# sourceMappingURL=matrixExtendedJs-53629e18.js.map
