(function(E){const{Craft:c,Garnish:h,$:e}=E;!c||!h||!e||(c.MatrixExtended=h.Base.extend({settings:{},childParent:{},helper:void 0,itemDrag:void 0,$trigger:void 0,init:function(r,a){const d=this;if(this.settings=r.settings||{},this.childParent=r.childParent||{},this.helper=a,!h.DisclosureMenu||!c.MatrixInput)return;const s=h.DisclosureMenu.prototype.show;h.DisclosureMenu.prototype.show=function(...n){d.initDisclosureMenu(this),s.apply(this,n)};const t=h.DisclosureMenu.prototype.init;h.DisclosureMenu.prototype.init=function(...n){t.apply(this,n),d.initAddButtonMenu(this),d.prepareEntryDropZones()};const l=c.MatrixInput.prototype.updateAddEntryBtn;if(c.MatrixInput.prototype.updateAddEntryBtn=function(...n){l.apply(this,n),d.checkAddBtn(this)},!this.settings.enableDragDrop)return;const i=c.MatrixInput.prototype.init;c.MatrixInput.prototype.init=function(...n){i.apply(this,n),this.entrySort.allowDragging=()=>!1,this.entrySort.destroy(),d.prepareEntryDropZones()},c.MatrixInput.prototype.canAddMoreEntries=function(){return!this.maxEntries||this.$entriesContainer.children(":not(.matrix-extended-drop-target):not(.matrix-extended-buttons)").length<this.maxEntries};const m=c.MatrixInput.prototype.canPaste;c.MatrixInput.prototype.canPaste=function(n){return n!=null&&n.length?m.apply(this,[n]):!1};const u=c.MatrixInput.prototype.updatePasteBtn;c.MatrixInput.prototype.updatePasteBtn=function(n){n=n||c.cp.getCopiedElements(),u.apply(this,[n])};const $=e(".matrix-field").find(".matrixblock");for(const n of $){const o=e(n);o.find("> .actions > .move-btn").remove(),o.find("> .actions").append('<div class="chromeless small move"><div class="inline-flex"><div class="cp-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" focusable="false" aria-hidden="true"><path d="M71.3 295.6c-21.9-21.9-21.9-57.3 0-79.2s57.3-21.9 79.2 0 21.9 57.3 0 79.2s-57.4 21.9-79.2 0zM184.4 182.5c-21.9-21.9-21.9-57.3 0-79.2s57.3-21.9 79.2 0 21.9 57.3 0 79.2-57.3 21.8-79.2 0zm0 147c21.9-21.9 57.3-21.9 79.2 0s21.9 57.3 0 79.2s-57.3 21.9-79.2 0c-21.9-21.8-21.9-57.3 0-79.2zM297.5 216.4c21.9-21.9 57.3-21.9 79.2 0s21.9 57.3 0 79.2s-57.3 21.9-79.2 0c-21.8-21.9-21.8-57.3 0-79.2z"></path></svg></div></div></div>')}this.itemDrag=new h.DragDrop({activeDropTargetClass:"active",minMouseDist:10,hideDraggee:!1,moveHelperToCursor:!0,handle:n=>e(n).find("> .actions > .move, > .titlebar"),filter:()=>this.itemDrag.$targetItem.closest(".matrixblock"),dropTargets:()=>{if(!this.childParent)return[];const{entry:n,typeId:o}=this.itemDrag.$draggee.closest(".matrixblock").data();return!n.matrix||!o?[]:e(".matrix-extended-drop-target").filter((b,x)=>(this.childParent[o]||[]).includes(e(x).data("entryTypeId"))).toArray().reverse()},onDragStart:()=>{h.$bod.addClass("dragging"),this.itemDrag.$draggee.closest(".matrixblock").addClass("draggee"),this.$dropEntry=this.itemDrag.$draggee.data("entry").$container,this.$pullBlock=this.$dropEntry.closest(".matrix-field")},onDragStop:async()=>{if(this.itemDrag.$draggee.closest(".matrixblock").removeClass("draggee"),h.$bod.removeClass("dragging"),!this.$dropEntry||!this.$pullBlock)return this.itemDrag.returnHelpersToDraggees();const n=this.$dropEntry,o=this.itemDrag.$activeDropTarget;if(!n||!o)return this.itemDrag.returnHelpersToDraggees();let f,g="insertBefore";o.data("position")==="button"?(f=o.closest(".matrix-field").find("> .blocks"),g="appendTo"):f=o.next(".matrixblock");const b=this.$pullBlock,x=o.closest(".matrix-field");if(b.is(x))g==="appendTo"?n.appendTo(f):n.insertBefore(f),b.data("matrix").entrySelect.resetItemOrder();else{const M=x.data("matrix"),y=b.data("matrix"),v=n.data("entry"),B=n.data("typeId");await this.duplicateWithNewOwner(f,g,B,v,M,y)}this.itemDrag.returnHelpersToDraggees(),this.prepareEntryDropZones(),this.$dropEntry=void 0,this.$pullBlock=void 0}})},prepareEntryDropZones(){if(!this.settings.enableDragDrop)return;const r=e(".matrix-field"),a=r.find(".matrixblock");e(".matrix-extended-drop-target").remove();for(const s of a){const t=e(s);let l=null;const i=t.data("entry");if(!i)return;const m=i.matrix;if(!m)return;l=m.settings.fieldId;const u=e('<div class="matrix-extended-drop-target" data-position="block"><div></div></div>');u.data(t.data()),u.data("entryTypeId",l),t.before(u)}const d=r.find("> .buttons");for(const s of d){const t=e(s),l=t.closest(".matrix-field").data("matrix");if(!l)continue;const i=e('<div class="matrix-extended-drop-target" data-position="button"><div></div></div>');i.data("entryTypeId",l.settings.fieldId),i.insertBefore(t)}this.itemDrag.removeAllItems(),this.itemDrag.addItems(a),h.$bod.addClass("matrix-extended-drag-drop")},initAddButtonMenu(r){const{$trigger:a,$container:d}=r,s=a.parent(),l=a.closest(".buttons").parent(".matrix-field");if(!a||!d||!s.hasClass("buttons")||!l.attr("id")||a._hasMatrixExtensionButtonsInitialized||(a._hasMatrixExtensionButtonsInitialized=!0,this.$trigger=a,!this.settings.expandMenu))return;a.hide();const i=e('<div class="buttons matrix-extended-buttons"></div>'),m=a.disclosureMenu().data("disclosureMenu").$container.find("button").clone().off().on("activate",async p=>{d.find("button").filter((n,o)=>e(o).data("type")===e(p.currentTarget).data("type")).trigger("activate")}),u=l.attr("id");this.buildGroupedMenu(i,m,a,u),i.appendTo(s)},initDisclosureMenu(r){const{$trigger:a,$container:d}=r;if(!a||!d||!a.hasClass("action-btn"))return;const s=a.closest(".actions").parent(".matrixblock");if(!s.length)return;const{typeId:t,entry:l}=s.data();if(!t||!l)return;const i=l.matrix;if(i){if(r._hasMatrixExtensionButtonsInitialized){this.checkAdd(d,i);return}r._hasMatrixExtensionButtonsInitialized=!0,this.addMenu(d,t,l,i)}},duplicateWithNewOwner:async function(r,a,d,s,t,l){var i;if(!t.addingEntry){if(!t.canAddMoreEntries()){t.updateStatusMessage();return}t.addingEntry=!0,t.elementEditor&&await t.elementEditor.setFormValue(t.settings.baseInputName,"*");try{const m=t.elementEditor.getDraftElementId(s.id),{data:u}=await c.sendActionRequest("POST","matrix-extended/matrix-extended/duplicate-entry-with-new-owner",{data:{fieldId:t.settings.fieldId,entryId:m,entryTypeId:d,ownerId:t.settings.ownerId,ownerElementType:t.settings.ownerElementType,siteId:t.settings.siteId,namespace:t.settings.namespace,staticEntries:t.settings.staticEntries}}),p=e(u.blockHtml);(i=t.elementEditor)==null||i.pause(),a==="appendTo"?p.appendTo(r):p.insertBefore(r),s.$container.hide(),t.trigger("entryAdded",{$entry:p}),p.css("margin-bottom",""),c.initUiElements(p.children(".fields")),await c.appendHeadHtml(u.headHtml),await c.appendBodyHtml(u.bodyHtml),new c.MatrixInput.Entry(t,p),t.entrySort.addItems(p),t.entrySelect.addItems(p),t.updateAddEntryBtn(),p.css(t.getHiddenEntryCss(p)).velocity({opacity:1,"margin-bottom":10},"fast"),h.requestAnimationFrame(function(){var $;($=t.elementEditor)==null||$.resume(),s.selfDestruct()})}catch{this.addStatusMessage(c.t("matrix-extended","There was an error dropping the entry"),"error")}t.addingEntry=!1,s.actionDisclosure.hide()}},addMenu:function(r,a,d,s){const t=e('<ul class="matrix-extended"></ul>'),l=e('<hr class="padded">');if(this.addAddBlockButton(t,a,d,s),this.checkAdd(t,s),t.insertBefore(r.find("ul").eq(0)),l.insertAfter(t),this.settings.removeEntryTypesFromDiscloseMenu){const i=r.find('[data-action="add"]').parent().parent();i.prev().hide(),i.hide()}},addAddBlockButton:function(r,a,d,s){if(!this.settings.enableAddBlockAbove||!s.$addEntryMenuBtn.length&&!s.$addEntryBtn.length)return;const t=e(`<li>
                    <button class="menu-item" data-action="add-block" tabindex="0">
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M64 80c-8.8 0-16 7.2-16 16V416c0 8.8 7.2 16 16 16H384c8.8 0 16-7.2 16-16V96c0-8.8-7.2-16-16-16H64zM0 96C0 60.7 28.7 32 64 32H384c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM200 344V280H136c-13.3 0-24-10.7-24-24s10.7-24 24-24h64V168c0-13.3 10.7-24 24-24s24 10.7 24 24v64h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H248v64c0 13.3-10.7 24-24 24s-24-10.7-24-24z"/></svg>
                        </span><span class="menu-item-label">${c.t("matrix-extended","Add block above")}</span>
                    </button>
                </li>`);r.append(t),t.on("click",'button[data-action="add-block"]',()=>{const l=s.id;e(".matrix-extended-buttons-above").remove();const i=d&&d.actionDisclosure&&d.actionDisclosure.$container?d.actionDisclosure.$container:null;if(!i)return;const m=i.find('[data-action="add"]');if(!m.length)return;const u=e('<div class="buttons matrix-extended-buttons matrix-extended-buttons-above"></div>'),p=m.clone().off().on("activate",$=>{const n=e($.currentTarget).data("type"),o=m.filter((f,g)=>e(g).data("type")===n);o.length&&o.trigger("activate"),setTimeout(()=>u.remove(),0)});if(p.each(($,n)=>{const o=e(n),g=this.$trigger.disclosureMenu().data("disclosureMenu").$container.find('[data-type="'+o.data("type")+'"]').text();g?e(n).text(g):e(n).text(e(n).text())}),this.settings.expandMenu)this.buildGroupedMenu(u,p,s.$addEntryMenuBtn,l,!0),s.updatePasteBtn();else{const $=s.$addEntryMenuBtn.find(".label").text(),n=`matrix-extended-menu-${l}-all`;e(`#${n}`).remove();const o=c.ui.createButton({label:$,spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",n).appendTo(u),f=e(`<div class="menu menu--disclosure mx-no-focus" id="${n}">`),g=e("<ul></ul>");f.append(g),e(document.body).append(f);const b=new h.DisclosureMenu(o);p.each((x,M)=>{const y=e("<li></li>"),v=e(M);y.append(v),g.append(y),v.on("activate",()=>{f.remove(),b.destroy(),setTimeout(()=>u.remove(),0)})})}u.insertBefore(d.$container),d.actionDisclosure&&d.actionDisclosure.hide()})},buildGroupedMenu:function(r,a,d,s,t=!1){const l=s.replace(/.*fields-/,"");let i=a;if(!this.settings.fields){const o=e('<div class="btngroup matrix-extended-btngroup"></div>');i.first().addClass("add icon"),i.addClass("btn dashed"),o.append(i),r.append(o);return}if(!this.settings.fields[l]){const o=e('<div class="btngroup matrix-extended-btngroup"></div>');i.first().addClass("add icon"),i.addClass("btn dashed"),o.append(i),r.append(o);return}const m=this.settings.fields[l];m.oneLiner&&r.addClass("one-line");for(const[o,f]of Object.entries(m.groups)){e(`#matrix-extended-menu-${s}-${o}${t?"-above":""}`).remove();const g=c.ui.createButton({label:f.label,spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${s}-${o}${t?"-above":""}`).appendTo(r),b=e(`<div class="menu menu--disclosure" id="matrix-extended-menu-${s}-${o}${t?"-above":""}">`),x=e("<ul></ul>");b.append(x),e(document.body).append(b);const M=new h.DisclosureMenu(g);for(const y of f.types){const v=e("<li></li>"),B=a.filter((w,D)=>e(D).data("type")===y);if(i=i.filter((w,D)=>e(D).data("type")!==y),!B.length){console.warn(`Type ${y} not found in group ${s}`);continue}v.append(B),x.append(v),B.on("activate",()=>{if(!t){M.hide();return}b.remove(),M.destroy()})}}if(!i.length)return;if(this.settings.expandUngrouped){const o=e('<div class="btngroup matrix-extended-btngroup"></div>');switch(i.first().addClass("add icon"),i.addClass("btn dashed"),o.append(i),this.settings.ungroupedPosition){case"start":r.prepend(o);break;case"end":r.append(o);break}return}e(`#matrix-extended-menu-${s}-others${t?"-above":""}`).remove();const u=c.ui.createButton({label:d.find(".label").text(),spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${s}-others${t?"-above":""}`);switch(this.settings.ungroupedPosition){case"start":u.prependTo(r);break;case"end":u.appendTo(r);break}const p=e(`<div class="menu menu--disclosure" id="matrix-extended-menu-${s}-others${t?"-above":""}">`),$=e("<ul></ul>");p.append($),e(document.body).append(p);const n=new h.DisclosureMenu(u);for(const o of i){const f=e("<li></li>"),g=e(o);f.append(g),$.append(f),g.on("activate",()=>{if(!t){n.hide();return}p.remove(),n.destroy()})}},checkAdd:function(r,a){const d=r.find('button[data-action="add-block"]');d.disable();const s=d.parent();if(s.attr("title",""),!a.canAddMoreEntries()){s.attr("title",c.t("matrix-extended","No more entries can be added."));return}d.enable()},checkAddBtn:function(r){if(!this.settings.expandMenu)return;const a=r.$container.find("> .blocks > .matrix-extended-buttons, > .buttons > .matrix-extended-buttons").find("button");a.disable();const d=a.parent();if(d.attr("title",""),!r.canAddMoreEntries()){d.attr("title",c.t("matrix-extended","No more entries can be added."));return}a.enable()},addStatusMessage:function(r,a="notice"){a==="notice"&&c.cp.displayNotice(r),a==="error"&&c.cp.displayError(r)}}))})(window);
//# sourceMappingURL=matrixExtendedJs-4d4d1af9.js.map
