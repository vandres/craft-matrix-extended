{"version":3,"file":"nestedElementExtendedJs-f113f26a.js","sources":["../../../../../static/src/js/nestedElementExtended.ts"],"sourcesContent":["(function (window: any) {\n    const {Craft, Garnish, $} = window;\n    if (!Craft || !Garnish || !$) {\n        return;\n    }\n\n    /**\n     * @see https://github.com/craftcms/cms/blob/5.x/src/web/assets/cp/src/js/NestedElementManager.js\n     */\n    Craft.NestedElementExtended = Garnish.Base.extend({\n        settings: {}, childParent: {}, helper: undefined,\n\n        init: function (config: { settings: any, childParent: any }, helper: any) {\n            const self = this;\n\n            this.settings = config.settings || {};\n            this.childParent = config.childParent || {};\n            this.helper = helper;\n\n            if (!Garnish.DisclosureMenu || !Craft.NestedElementManager) {\n                return;\n            }\n\n            const disclosureMenuInitFn = Garnish.DisclosureMenu.prototype.init;\n            Garnish.DisclosureMenu.prototype.init = function (...args: any[]) {\n                disclosureMenuInitFn.apply(this, args);\n                self.initAddButtonMenu(this);\n            };\n        },\n\n        initAddButtonMenu(disclosureMenu: any) {\n            if (!this.settings.expandMenu) {\n                return;\n            }\n\n            const {$trigger, $container} = disclosureMenu;\n            const $parent = $trigger.parent();\n            const $wrapper = $trigger.closest('.nested-element-cards');\n            const nem = $wrapper.data('nestedElementManager');\n            if (!nem || !$trigger || !$container || $parent.hasClass('card-actions') || !$wrapper.attr('id')) {\n                return;\n            }\n\n            if (!Array.isArray(nem.settings.createAttributes)) {\n                return;\n            }\n\n            if ($trigger._hasNestedElementExtensionButtonsInitialized) {\n                return;\n            }\n            $trigger.hide();\n            $trigger._hasNestedElementExtensionButtonsInitialized = true;\n\n            const $buttonContainer = $('<div class=\"buttons matrix-extended-buttons\"></div>');\n\n            const $createBtn = Craft.ui\n                .createButton({\n                    label: nem.settings.createButtonLabel,\n                    spinner: true,\n                })\n                .addClass('add icon disabled');\n\n            const $btnContainer = $('<div/>').appendTo($container);\n            $createBtn.addClass('dashed').appendTo($btnContainer);\n\n            const createMenuId = `menu-${Math.floor(Math.random() * 1000000)}`;\n            const $menu = $('<div/>', {\n                id: createMenuId,\n                class: 'menu menu--disclosure',\n            }).insertAfter($createBtn);\n            const $ul = $('<ul/>').appendTo($menu);\n            for (const type of nem.settings.createAttributes) {\n                const $li = $('<li/>').appendTo($ul);\n                let buttonHtml = '';\n                if (type.icon) {\n                    const $icon = $(`<span class=\"icon\">${type.icon}</span>`);\n                    if (type.color) {\n                        $icon.addClass(type.color);\n                    }\n                    buttonHtml += $icon.prop('outerHTML');\n                }\n                buttonHtml += `<span class=\"label\">${type.label}</span>`;\n                const $button = $('<button/>', {\n                    type: 'button',\n                    class: 'menu-item',\n                    'data-type': this.helper.getEntryTypeById(type.attributes.typeId).name,\n                    html: buttonHtml,\n                }).appendTo($li);\n                this.addListener($button, 'activate', (ev: any) => {\n                    ev.preventDefault();\n                    $createBtn.data('disclosureMenu').hide();\n                    nem.createElement(type.attributes);\n                });\n            }\n            $createBtn\n                .attr('aria-controls', createMenuId)\n                .attr('data-disclosure-trigger', 'true')\n                .addClass('menubtn')\n                .disclosureMenu();\n\n            const $actionButtons = $createBtn\n                .disclosureMenu()\n                .data('disclosureMenu')\n                .$container.find('button')\n                .clone()\n                .off()\n                .on('activate', async (ev: any) => {\n                    const $target = $(ev.currentTarget);\n                    const $button = $createBtn\n                        .disclosureMenu()\n                        .data('disclosureMenu')\n                        .$container.find('button').filter((_: any, x: any) => $(x).data('type') === $target.data('type'));\n                    $button.trigger('activate');\n                });\n\n            const id = $wrapper.attr('id');\n            this.buildGroupedMenu($buttonContainer, $actionButtons, $trigger, id);\n\n            $buttonContainer.appendTo($parent);\n        },\n\n        buildGroupedMenu: function ($buttonContainer: any, $actionButtons: any, $actionBtn: any, id: any, above = false) {\n            let fieldIndex: string = id.replace(/.*fields-/, '');\n            fieldIndex = fieldIndex.replace(/-element-index-.*/, '');\n\n            let $unused = $actionButtons;\n            if (!this.settings.fields) {\n                const $actionButtonContainer = $('<div class=\"btngroup matrix-extended-btngroup\"></div>')\n                $unused.first().addClass('add icon');\n                $unused.addClass('btn dashed');\n                $actionButtonContainer.append($unused);\n                $buttonContainer.append($actionButtonContainer)\n                return;\n            }\n\n            if (!this.settings.fields[fieldIndex]) {\n                const $actionButtonContainer = $('<div class=\"btngroup matrix-extended-btngroup\"></div>')\n                $unused.first().addClass('add icon');\n                $unused.addClass('btn dashed');\n                $actionButtonContainer.append($unused);\n                $buttonContainer.append($actionButtonContainer)\n                return;\n            }\n\n            const fieldGroup: Record<string, { groups: any, oneLiner: boolean }> = this.settings.fields[fieldIndex];\n            if (fieldGroup.oneLiner) {\n                $buttonContainer.addClass('one-line');\n            }\n            for (const [index, group] of Object.entries(fieldGroup.groups)) {\n                $(`#matrix-extended-menu-${id}-${index}${above ? '-above' : ''}`).remove();\n\n                const $groupedMenuButton = Craft.ui\n                    .createButton({\n                        label: group.label, spinner: true,\n                    })\n                    .addClass('btn menubtn dashed add icon')\n                    .attr('aria-controls', `matrix-extended-menu-${id}-${index}${above ? '-above' : ''}`)\n                    .appendTo($buttonContainer);\n                const $menuContainer = $(`<div class=\"menu menu--disclosure\" id=\"matrix-extended-menu-${id}-${index}${above ? '-above' : ''}\">`);\n                const $menu = $('<ul></ul>');\n\n                $menuContainer.append($menu);\n                $(document.body).append($menuContainer);\n                const disclosure = new Garnish.DisclosureMenu($groupedMenuButton);\n\n                for (const type of group.types) {\n                    const $li = $(`<li></li>`);\n                    const $button = $actionButtons.filter((_: any, x: any) => $(x).data('type') === type);\n                    $unused = $unused.filter((_: any, x: any) => $(x).data('type') !== type);\n                    if (!$button.length) {\n                        console.warn(`Type ${type} not found in group ${id}`)\n                        continue;\n                    }\n                    $li.append($button);\n                    $menu.append($li);\n                    $button.on('activate', () => {\n                        if (!above) {\n                            disclosure.hide();\n                            return;\n                        }\n                        $menuContainer.remove();\n                        disclosure.destroy();\n                    });\n                }\n            }\n\n            if (!$unused.length) {\n                return;\n            }\n\n            if (this.settings.expandUngrouped) {\n                const $actionButtonContainer = $('<div class=\"btngroup matrix-extended-btngroup\"></div>')\n                $unused.first().addClass('add icon');\n                $unused.addClass('btn dashed');\n                $actionButtonContainer.append($unused);\n                switch (this.settings.ungroupedPosition) {\n                    case 'start':\n                        $buttonContainer.prepend($actionButtonContainer);\n                        break;\n                    case 'end':\n                        $buttonContainer.append($actionButtonContainer)\n                        break;\n                }\n                return;\n            }\n\n            $(`#matrix-extended-menu-${id}-others${above ? '-above' : ''}`).remove();\n            const $groupedMenuButton = Craft.ui\n                .createButton({\n                    label: $actionBtn.find('.label').text(), spinner: true,\n                })\n                .addClass('btn menubtn dashed add icon')\n                .attr('aria-controls', `matrix-extended-menu-${id}-others${above ? '-above' : ''}`);\n\n            switch (this.settings.ungroupedPosition) {\n                case 'start':\n                    $groupedMenuButton.prependTo($buttonContainer);\n                    break;\n                case 'end':\n                    $groupedMenuButton.appendTo($buttonContainer);\n                    break;\n            }\n\n            const $menuContainer = $(`<div class=\"menu menu--disclosure\" id=\"matrix-extended-menu-${id}-others${above ? '-above' : ''}\">`);\n            const $menu = $('<ul></ul>');\n\n            $menuContainer.append($menu);\n            $(document.body).append($menuContainer);\n            const disclosure = new Garnish.DisclosureMenu($groupedMenuButton);\n\n            for (const button of $unused) {\n                const $li = $(`<li></li>`);\n                const $button = $(button);\n                $li.append($button);\n                $menu.append($li);\n                $button.on('activate', () => {\n                    if (!above) {\n                        disclosure.hide();\n                        return;\n                    }\n                    $menuContainer.remove();\n                    disclosure.destroy();\n                })\n            }\n        },\n    });\n})(window);\n"],"names":["window","Craft","Garnish","$","config","helper","self","disclosureMenuInitFn","args","disclosureMenu","$trigger","$container","$parent","$wrapper","nem","$buttonContainer","$createBtn","$btnContainer","createMenuId","$menu","$ul","type","$li","buttonHtml","$icon","$button","ev","$actionButtons","$target","_","x","id","$actionBtn","above","fieldIndex","$unused","$actionButtonContainer","fieldGroup","index","group","$groupedMenuButton","$menuContainer","disclosure","button"],"mappings":"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"}