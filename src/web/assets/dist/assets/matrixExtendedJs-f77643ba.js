(function(D){const{Craft:l,Garnish:m,$:n}=D;!l||!m||!n||(l.MatrixExtended=m.Base.extend({settings:{},childParent:{},helper:void 0,itemDrag:void 0,init:function(r,o){const a=this;if(this.settings=r.settings||{},this.childParent=r.childParent||{},this.helper=o,!m.DisclosureMenu||!l.MatrixInput)return;const i=m.DisclosureMenu.prototype.show;m.DisclosureMenu.prototype.show=function(...e){a.initDisclosureMenu(this),i.apply(this,e)};const t=m.DisclosureMenu.prototype.init;m.DisclosureMenu.prototype.init=function(...e){t.apply(this,e),a.initAddButtonMenu(this),a.prepareEntryDropZones()};const u=l.MatrixInput.prototype.updateAddEntryBtn;if(l.MatrixInput.prototype.updateAddEntryBtn=function(...e){u.apply(this,e),a.checkAddBtn(this)},!this.settings.enableDragDrop)return;const s=l.MatrixInput.prototype.init;l.MatrixInput.prototype.init=function(...e){s.apply(this,e),this.entrySort.allowDragging=()=>!1,this.entrySort.destroy(),a.prepareEntryDropZones()},l.MatrixInput.prototype.canAddMoreEntries=function(){return!this.maxEntries||this.$entriesContainer.children(":not(.matrix-extended-drop-target):not(.matrix-extended-buttons)").length<this.maxEntries};const p=n(".matrix-field").find(".matrixblock");for(const e of p){const c=n(e);c.find("> .actions > .move-btn").remove(),c.find("> .actions").append('<div class="chromeless small move"><div class="inline-flex"><div class="cp-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" focusable="false" aria-hidden="true"><path d="M71.3 295.6c-21.9-21.9-21.9-57.3 0-79.2s57.3-21.9 79.2 0 21.9 57.3 0 79.2s-57.4 21.9-79.2 0zM184.4 182.5c-21.9-21.9-21.9-57.3 0-79.2s57.3-21.9 79.2 0 21.9 57.3 0 79.2-57.3 21.8-79.2 0zm0 147c21.9-21.9 57.3-21.9 79.2 0s21.9 57.3 0 79.2s-57.3 21.9-79.2 0c-21.9-21.8-21.9-57.3 0-79.2zM297.5 216.4c21.9-21.9 57.3-21.9 79.2 0s21.9 57.3 0 79.2s-57.3 21.9-79.2 0c-21.8-21.9-21.8-57.3 0-79.2z"></path></svg></div></div></div>')}this.itemDrag=new m.DragDrop({activeDropTargetClass:"active",minMouseDist:10,hideDraggee:!1,moveHelperToCursor:!0,handle:e=>n(e).find("> .actions > .move, > .titlebar"),filter:()=>this.itemDrag.$targetItem.closest(".matrixblock"),dropTargets:()=>{if(!this.childParent)return[];const{entry:e,typeId:c}=this.itemDrag.$draggee.closest(".matrixblock").data();return!e.matrix||!c?[]:n(".matrix-extended-drop-target").filter((g,$)=>(this.childParent[c]||[]).includes(n($).data("entryTypeId"))).toArray().reverse()},onDragStart:()=>{m.$bod.addClass("dragging"),this.itemDrag.$draggee.closest(".matrixblock").addClass("draggee"),this.$dropEntry=this.itemDrag.$draggee.data("entry").$container,this.$pullBlock=this.$dropEntry.closest(".matrix-field")},onDragStop:async()=>{if(this.itemDrag.$draggee.closest(".matrixblock").removeClass("draggee"),m.$bod.removeClass("dragging"),!this.$dropEntry||!this.$pullBlock)return this.itemDrag.returnHelpersToDraggees();const e=this.$dropEntry,c=this.itemDrag.$activeDropTarget;if(!e||!c)return this.itemDrag.returnHelpersToDraggees();let h,d="insertBefore";c.data("position")==="button"?(h=c.closest(".matrix-field").find("> .blocks"),d="appendTo"):h=c.next(".matrixblock");const g=this.$pullBlock,$=c.closest(".matrix-field");if(g.is($))d==="appendTo"?e.appendTo(h):e.insertBefore(h),g.data("matrix").entrySelect.resetItemOrder();else{const b=$.data("matrix"),y=g.data("matrix"),v=e.data("entry"),x=e.data("typeId");await this.duplicateWithNewOwner(h,d,x,v,b,y)}this.itemDrag.returnHelpersToDraggees(),this.prepareEntryDropZones(),this.$dropEntry=void 0,this.$pullBlock=void 0}})},prepareEntryDropZones(){var i,t;if(!this.settings.experimentalFeatures||!this.settings.enableDragDrop)return;const r=n(".matrix-field"),o=r.find(".matrixblock");n(".matrix-extended-drop-target").remove();for(const u of o){const s=n(u);let f=null;const p=s.data("entry");if(!p)return;const e=p.matrix;if(!e)return;f=e.settings.fieldId;const c=n('<div class="matrix-extended-drop-target" data-position="block"><div></div></div>');c.data(s.data()),c.data("entryTypeId",f),s.before(c),e.updatePasteBtn(),l.cp.getCopiedElements().length||(i=e.$pasteBtn)==null||i.addClass("hidden")}const a=r.find("> .buttons");for(const u of a){const s=n(u),f=s.closest(".matrix-field").data("matrix");if(!f)continue;const p=n('<div class="matrix-extended-drop-target" data-position="button"><div></div></div>');p.data("entryTypeId",f.settings.fieldId),p.insertBefore(s),f.updatePasteBtn(),l.cp.getCopiedElements().length||(t=f.$pasteBtn)==null||t.addClass("hidden")}this.itemDrag.removeAllItems(),this.itemDrag.addItems(o),m.$bod.addClass("matrix-extended-drag-drop")},initAddButtonMenu(r){if(!this.settings.expandMenu)return;const{$trigger:o,$container:a}=r,i=o.parent(),u=o.closest(".buttons").parent(".matrix-field");if(!o||!a||!i.hasClass("buttons")||!u.attr("id")||o._hasMatrixExtensionButtonsInitialized)return;o.hide(),o._hasMatrixExtensionButtonsInitialized=!0;const s=n('<div class="buttons matrix-extended-buttons"></div>'),f=o.disclosureMenu().data("disclosureMenu").$container.find("button").clone().off().on("activate",async e=>{a.find("button").filter((h,d)=>n(d).data("type")===n(e.currentTarget).data("type")).trigger("activate")}),p=u.attr("id");this.buildGroupedMenu(s,f,o,p),s.appendTo(i)},initDisclosureMenu(r){const{$trigger:o,$container:a}=r;if(!o||!a||!o.hasClass("action-btn"))return;const i=o.closest(".actions").parent(".matrixblock");if(!i.length)return;const{typeId:t,entry:u}=i.data();if(!t||!u)return;const s=u.matrix;if(s){if(r._hasMatrixExtensionButtonsInitialized){this.checkAdd(a,s);return}r._hasMatrixExtensionButtonsInitialized=!0,this.addMenu(a,t,u,s)}},duplicateWithNewOwner:async function(r,o,a,i,t,u){var s;if(!t.addingEntry){if(!t.canAddMoreEntries()){t.updateStatusMessage();return}t.addingEntry=!0,t.elementEditor&&await t.elementEditor.setFormValue(t.settings.baseInputName,"*");try{const f=t.elementEditor.getDraftElementId(i.id),{data:p}=await l.sendActionRequest("POST","matrix-extended/matrix-extended/duplicate-entry-with-new-owner",{data:{fieldId:t.settings.fieldId,entryId:f,entryTypeId:a,ownerId:t.settings.ownerId,ownerElementType:t.settings.ownerElementType,siteId:t.settings.siteId,namespace:t.settings.namespace,staticEntries:t.settings.staticEntries}}),e=n(p.blockHtml);(s=t.elementEditor)==null||s.pause(),o==="appendTo"?e.appendTo(r):e.insertBefore(r),i.$container.hide(),t.trigger("entryAdded",{$entry:e}),e.css("margin-bottom",""),l.initUiElements(e.children(".fields")),await l.appendHeadHtml(p.headHtml),await l.appendBodyHtml(p.bodyHtml),new l.MatrixInput.Entry(t,e),t.entrySort.addItems(e),t.entrySelect.addItems(e),t.updateAddEntryBtn(),e.css(t.getHiddenEntryCss(e)).velocity({opacity:1,"margin-bottom":10},"fast"),m.requestAnimationFrame(function(){var c;(c=t.elementEditor)==null||c.resume(),i.selfDestruct()})}catch{this.addStatusMessage(l.t("matrix-extended","There was an error dropping the entry"),"error")}t.addingEntry=!1,i.actionDisclosure.hide()}},addMenu:function(r,o,a,i){const t=n('<ul class="matrix-extended"></ul>'),u=n('<hr class="padded">');if(this.addAddBlockButton(t,o,a,i),this.checkAdd(t,i),t.insertBefore(r.find("ul").eq(0)),u.insertAfter(t),this.settings.removeEntryTypesFromDiscloseMenu){const s=r.find('[data-action="add"]').parent().parent();s.prev().remove(),s.remove()}},addAddBlockButton:function(r,o,a,i){if(!this.settings.enableAddBlockAbove||!i.$addEntryMenuBtn.length&&!i.$addEntryBtn.length)return;const t=n(`<li>
                    <button class="menu-item" data-action="add-block" tabindex="0">
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M64 80c-8.8 0-16 7.2-16 16V416c0 8.8 7.2 16 16 16H384c8.8 0 16-7.2 16-16V96c0-8.8-7.2-16-16-16H64zM0 96C0 60.7 28.7 32 64 32H384c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM200 344V280H136c-13.3 0-24-10.7-24-24s10.7-24 24-24h64V168c0-13.3 10.7-24 24-24s24 10.7 24 24v64h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H248v64c0 13.3-10.7 24-24 24s-24-10.7-24-24z"/></svg>
                        </span><span class="menu-item-label">${l.t("matrix-extended","Add block above")}</span>
                    </button>
                </li>`);r.append(t),t.find("button").on("click",()=>{const u=i.id;n(".matrix-extended-buttons-above").remove(),n(`#matrix-extended-menu-${u}-all`).remove();const s=n('<div class="buttons matrix-extended-buttons matrix-extended-buttons-above"></div>'),f=i.$addEntryMenuBtn.length?i.$addEntryMenuBtn.data("disclosureMenu").$container.find("button").clone().off():i.$addEntryBtn.clone().off(),p=l.ui.createButton({label:i.$addEntryMenuBtn.find(".label").text(),spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${u}-all`),e=n(`<div class="menu menu--disclosure" id="matrix-extended-menu-${u}-all">`),c=n("<ul></ul>");e.append(c),n(document.body).append(e);const h=new m.DisclosureMenu(p);for(const d of f){const g=n("<li></li>"),$=n(d);g.append($),c.append(g)}if(f.on("activate",async d=>{if(n(d.currentTarget).closest(`#matrix-extended-menu-${u}-all`).length){p.addClass("loading");try{await i.addEntry(n(d.currentTarget).data("type"),a.$container[0].checkVisibility()?a.$container:void 0)}finally{h.hide(),p.remove(),e.remove(),s.remove()}}}),this.settings.expandMenu){const g=p.data("disclosureMenu").$container.find("button").clone(!0,!0);this.buildGroupedMenu(s,g,p,u,!0)}else s.append(p);s.insertBefore(a.$container),a.actionDisclosure.hide()})},buildGroupedMenu:function(r,o,a,i,t=!1){const u=i.replace(/.*fields-/,"");let s=o;if(!this.settings.fields){const d=n('<div class="btngroup matrix-extended-btngroup"></div>');s.first().addClass("add icon"),s.addClass("btn dashed"),d.append(s),r.append(d);return}if(!this.settings.fields[u]){const d=n('<div class="btngroup matrix-extended-btngroup"></div>');s.first().addClass("add icon"),s.addClass("btn dashed"),d.append(s),r.append(d);return}const f=this.settings.fields[u];f.oneLiner&&r.addClass("one-line");for(const[d,g]of Object.entries(f.groups)){n(`#matrix-extended-menu-${i}-${d}${t?"-above":""}`).remove();const $=l.ui.createButton({label:g.label,spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${i}-${d}${t?"-above":""}`).appendTo(r),b=n(`<div class="menu menu--disclosure" id="matrix-extended-menu-${i}-${d}${t?"-above":""}">`),y=n("<ul></ul>");b.append(y),n(document.body).append(b);const v=new m.DisclosureMenu($);for(const x of g.types){const E=n("<li></li>"),B=o.filter((w,M)=>n(M).data("type")===x);if(s=s.filter((w,M)=>n(M).data("type")!==x),!B.length){console.warn(`Type ${x} not found in group ${i}`);continue}E.append(B),y.append(E),B.on("activate",()=>{if(!t){v.hide();return}b.remove(),v.destroy()})}}if(!s.length)return;if(this.settings.expandUngrouped){const d=n('<div class="btngroup matrix-extended-btngroup"></div>');switch(s.first().addClass("add icon"),s.addClass("btn dashed"),d.append(s),this.settings.ungroupedPosition){case"start":r.prepend(d);break;case"end":r.append(d);break}return}n(`#matrix-extended-menu-${i}-others${t?"-above":""}`).remove();const p=l.ui.createButton({label:a.find(".label").text(),spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${i}-others${t?"-above":""}`);switch(this.settings.ungroupedPosition){case"start":p.prependTo(r);break;case"end":p.appendTo(r);break}const e=n(`<div class="menu menu--disclosure" id="matrix-extended-menu-${i}-others${t?"-above":""}">`),c=n("<ul></ul>");e.append(c),n(document.body).append(e);const h=new m.DisclosureMenu(p);for(const d of s){const g=n("<li></li>"),$=n(d);g.append($),c.append(g),$.on("activate",()=>{if(!t){h.hide();return}e.remove(),h.destroy()})}},checkAdd:function(r,o){const a=r.find('button[data-action="add-block"]');a.disable();const i=a.parent();if(i.attr("title",""),!o.canAddMoreEntries()){i.attr("title",l.t("matrix-extended","No more entries can be added."));return}a.enable()},checkAddBtn:function(r){if(!this.settings.expandMenu)return;const o=r.$container.find("> .blocks > .matrix-extended-buttons, > .buttons > .matrix-extended-buttons").find("button");o.disable();const a=o.parent();if(a.attr("title",""),!r.canAddMoreEntries()){a.attr("title",l.t("matrix-extended","No more entries can be added."));return}o.enable()},addStatusMessage:function(r,o="notice"){o==="notice"&&l.cp.displayNotice(r),o==="error"&&l.cp.displayError(r)}}))})(window);
//# sourceMappingURL=matrixExtendedJs-f77643ba.js.map
