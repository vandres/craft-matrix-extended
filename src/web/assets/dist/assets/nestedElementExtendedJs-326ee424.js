(function(E){const{Craft:r,Garnish:f,$:d}=E;!r||!f||!d||(r.NestedElementExtended=f.Base.extend({settings:{},childParent:{},helper:void 0,init:function(s,n){const i=this;if(this.settings=s.settings||{},this.childParent=s.childParent||{},this.helper=n,!f.DisclosureMenu||!r.NestedElementManager)return;const e=r.NestedElementManager.prototype.init;r.NestedElementManager.prototype.init=function(...o){e.apply(this,o)};const t=f.DisclosureMenu.prototype.show;f.DisclosureMenu.prototype.show=function(...o){i.initDisclosureMenu(this),t.apply(this,o)};const a=f.DisclosureMenu.prototype.init;f.DisclosureMenu.prototype.init=function(...o){a.apply(this,o),i.initAddButtonMenu(this)}},initDisclosureMenu(s){if(!this.settings.experimentalFeatures)return;const{$trigger:n,$container:i}=s;if(!n||!i||!n.hasClass("action-btn"))return;const e=n.closest(".card-actions").parent(".card-actions-container").parent(".card");if(!e.length)return;const{typeId:t,id:a}=e.data();if(!t||!a)return;const c=e.closest(".nested-element-cards").data("nestedElementManager");if(c&&!(c.settings.mode!=="cards"||!c.settings.canCreate)){if(s._hasNestedElementExtensionButtonsInitialized){this.checkPaste(i,e,c),this.checkDuplicate(i,c);return}s._hasNestedElementExtensionButtonsInitialized=!0,this.addMenu(i,t,e,c)}},initAddButtonMenu(s){if(!this.settings.expandMenu)return;const{$trigger:n,$container:i}=s,e=n.parent(),t=n.closest(".nested-element-cards"),a=t.data("nestedElementManager");if(!a||!n||!i||e.hasClass("card-actions")||!t.attr("id")||!Array.isArray(a.settings.createAttributes)||n._hasNestedElementExtensionButtonsInitialized)return;n.hide(),n._hasNestedElementExtensionButtonsInitialized=!0;const o=d('<div class="buttons matrix-extended-buttons"></div>'),c=r.ui.createButton({label:a.settings.createButtonLabel,spinner:!0}).addClass("add icon disabled"),y=d("<div/>").appendTo(i);c.addClass("dashed").appendTo(y);const m=`menu-${Math.floor(Math.random()*1e6)}`,p=d("<div/>",{id:m,class:"menu menu--disclosure"}).insertAfter(c),$=d("<ul/>").appendTo(p);for(const u of a.settings.createAttributes){const x=d("<li/>").appendTo($);let w="";if(u.icon){const h=d(`<span class="icon">${u.icon}</span>`);u.color&&h.addClass(u.color),w+=h.prop("outerHTML")}w+=`<span class="label">${u.label}</span>`;const b=d("<button/>",{type:"button",class:"menu-item","data-type":this.helper.getEntryTypeById(u.attributes.typeId).name,html:w}).appendTo(x);this.addListener(b,"activate",h=>{h.preventDefault(),c.data("disclosureMenu").hide(),a.createElement(u.attributes)})}c.attr("aria-controls",m).attr("data-disclosure-trigger","true").addClass("menubtn").disclosureMenu();const l=c.disclosureMenu().data("disclosureMenu").$container.find("button").clone().off().on("activate",async u=>{const x=d(u.currentTarget);c.disclosureMenu().data("disclosureMenu").$container.find("button").filter((b,h)=>d(h).data("type")===x.data("type")).trigger("activate")}),g=t.attr("id");this.buildGroupedMenu(o,l,n,g),o.appendTo(e)},buildGroupedMenu:function(s,n,i,e,t=!1){let a=e.replace(/.*fields-/,"");a=a.replace(/-element-index-.*/,"");let o=n;if(!this.settings.fields){const l=d('<div class="btngroup matrix-extended-btngroup"></div>');o.first().addClass("add icon"),o.addClass("btn dashed"),l.append(o),s.append(l);return}if(!this.settings.fields[a]){const l=d('<div class="btngroup matrix-extended-btngroup"></div>');o.first().addClass("add icon"),o.addClass("btn dashed"),l.append(o),s.append(l);return}const c=this.settings.fields[a];c.oneLiner&&s.addClass("one-line");for(const[l,g]of Object.entries(c.groups)){d(`#matrix-extended-menu-${e}-${l}${t?"-above":""}`).remove();const u=r.ui.createButton({label:g.label,spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${e}-${l}${t?"-above":""}`).appendTo(s),x=d(`<div class="menu menu--disclosure" id="matrix-extended-menu-${e}-${l}${t?"-above":""}">`),w=d("<ul></ul>");x.append(w),d(document.body).append(x);const b=new f.DisclosureMenu(u);for(const h of g.types){const B=d("<li></li>"),M=n.filter((C,I)=>d(I).data("type")===h);if(o=o.filter((C,I)=>d(I).data("type")!==h),!M.length){console.warn(`Type ${h} not found in group ${e}`);continue}B.append(M),w.append(B),M.on("activate",()=>{if(!t){b.hide();return}x.remove(),b.destroy()})}}if(!o.length)return;if(this.settings.expandUngrouped){const l=d('<div class="btngroup matrix-extended-btngroup"></div>');o.first().addClass("add icon"),o.addClass("btn dashed"),l.append(o),this.settings.ungroupedPosition==="end"?s.append(l):s.prepend(l);return}d(`#matrix-extended-menu-${e}-others${t?"-above":""}`).remove();const y=r.ui.createButton({label:i.find(".label").text(),spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${e}-others${t?"-above":""}`);this.settings.ungroupedPosition==="end"?y.appendTo(s):y.prependTo(s);const m=d(`<div class="menu menu--disclosure" id="matrix-extended-menu-${e}-others${t?"-above":""}">`),p=d("<ul></ul>");m.append(p),d(document.body).append(m);const $=new f.DisclosureMenu(y);for(const l of o){const g=d("<li></li>"),u=d(l);g.append(u),p.append(g),u.on("activate",()=>{if(!t){$.hide();return}m.remove(),$.destroy()})}},addMenu:function(s,n,i,e){const t=d('<ul class="matrix-extended"></ul>'),a=d('<hr class="padded">');this.addDuplicateButton(s,t,n,i,e),this.addCopyButton(s,t,n,i,e),this.addPasteButton(s,t,n,i,e),t.insertBefore(s.find("ul").eq(0)),a.insertAfter(t),this.checkPaste(s,i,e),this.checkDuplicate(s,e)},addDuplicateButton:function(s,n,i,e,t){const a=d(`<li>
                <button class="menu-item" data-action="duplicate" tabindex="0">
                    <span class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M64 464H288c8.8 0 16-7.2 16-16V384h48v64c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V224c0-35.3 28.7-64 64-64h64v48H64c-8.8 0-16 7.2-16 16V448c0 8.8 7.2 16 16 16zM224 304H448c8.8 0 16-7.2 16-16V64c0-8.8-7.2-16-16-16H224c-8.8 0-16 7.2-16 16V288c0 8.8 7.2 16 16 16zm-64-16V64c0-35.3 28.7-64 64-64H448c35.3 0 64 28.7 64 64V288c0 35.3-28.7 64-64 64H224c-35.3 0-64-28.7-64-64z"/></svg>
                    </span><span class="menu-item-label">${r.t("matrix-extended","Duplicate")}</span>
                </button>
            </li>`);n.append(a),a.find("button").on("click",()=>{this.duplicateEntry(s,n,i,e,t)})},duplicateEntry:async function(s,n,i,e,t){if(t.canCreate()){try{await t.markAsDirty();const{data:a}=await r.sendActionRequest("POST","matrix-extended/nested-element-extended/duplicate-entry",{data:{fieldId:e.data().fieldId,entryId:e.data().id,entryTypeId:i,ownerId:t.settings.ownerId,ownerElementType:t.settings.ownerElementType,siteId:t.settings.ownerSiteId}});await this.addElementCard(a,t,e.data("id"))}catch{this.addStatusMessage(r.t("matrix-extended","There was an error duplicating the entry"),"error")}s.data("disclosureMenu").hide()}},checkDuplicate:function(s,n){const i=s.find('button[data-action="duplicate"]');i.disable();const e=i.parent();if(e.attr("title",""),!n.canCreate()){e.attr("title",r.t("matrix-extended","No more entries can be added."));return}i.enable()},addCopyButton:function(s,n,i,e,t){const a=d(`<li>
                    <button class="menu-item" data-action="copy" tabindex="0">
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M280 64h40c35.3 0 64 28.7 64 64V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128C0 92.7 28.7 64 64 64h40 9.6C121 27.5 153.3 0 192 0s71 27.5 78.4 64H280zM64 112c-8.8 0-16 7.2-16 16V448c0 8.8 7.2 16 16 16H320c8.8 0 16-7.2 16-16V128c0-8.8-7.2-16-16-16H304v24c0 13.3-10.7 24-24 24H192 104c-13.3 0-24-10.7-24-24V112H64zm128-8a24 24 0 1 0 0-48 24 24 0 1 0 0 48z"/></svg>
                        </span><span class="menu-item-label">${r.t("matrix-extended","Copy")}</span>
                    </button>
                </li>`);n.append(a),a.find("button").on("click",()=>{this.copyEntry(s,n,i,e,t)})},copyEntry:async function(s,n,i,e,t){try{const{data:a}=await r.sendActionRequest("POST","matrix-extended/nested-element-extended/copy-entry",{data:{fieldId:e.data().fieldId,entryId:e.data().id,entryTypeId:i,ownerId:t.settings.ownerId,ownerElementType:t.settings.ownerElementType,siteId:t.settings.ownerSiteId}});this.helper.setEntryReference(a.entryReference),this.checkPaste(s,e,t),this.checkDuplicate(s,t),await r.appendHeadHtml(a.headHtml),await r.appendBodyHtml(a.bodyHtml),this.addStatusMessage(r.t("matrix-extended","Entry reference copied"))}catch{this.addStatusMessage(r.t("matrix-extended","There was an error copying the entry reference"),"error")}s.data("disclosureMenu").hide()},addPasteButton:function(s,n,i,e,t){const a=d(`<li>
            <button class="menu-item" data-action="paste" tabindex="0"> 
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M104.6 48H64C28.7 48 0 76.7 0 112V384c0 35.3 28.7 64 64 64h96V400H64c-8.8 0-16-7.2-16-16V112c0-8.8 7.2-16 16-16H80c0 17.7 14.3 32 32 32h72.4C202 108.4 227.6 96 256 96h62c-7.1-27.6-32.2-48-62-48H215.4C211.6 20.9 188.2 0 160 0s-51.6 20.9-55.4 48zM144 56a16 16 0 1 1 32 0 16 16 0 1 1 -32 0zM448 464H256c-8.8 0-16-7.2-16-16V192c0-8.8 7.2-16 16-16l140.1 0L464 243.9V448c0 8.8-7.2 16-16 16zM256 512H448c35.3 0 64-28.7 64-64V243.9c0-12.7-5.1-24.9-14.1-33.9l-67.9-67.9c-9-9-21.2-14.1-33.9-14.1H256c-35.3 0-64 28.7-64 64V448c0 35.3 28.7 64 64 64z"/></svg>
                        </span><span class="menu-item-label">${r.t("matrix-extended","Paste")}</span>
                    </button>
                </li>`);n.append(a),a.find("button").on("click",()=>{this.pasteEntry(s,n,i,e,t)})},checkPaste:function(s,n,i){const e=s.find('button[data-action="paste"]');e.disable();const t=e.parent();if(t.attr("title",""),!this.helper.getEntryReference()||!this.helper.getEntryReference().entryTypeId){t.attr("title",r.t("matrix-extended","There is nothing to paste."));return}if(!i.canCreate()){t.attr("title",r.t("matrix-extended","No more entries can be added."));return}if(!this.helper.isEntryReferenceAllowed(n.data().fieldId)){t.attr("title",r.t("matrix-extended","The copied entry is not allowed here."));return}e.enable()},pasteEntry:async function(s,n,i,e,t){if(t.canCreate()){try{await t.markAsDirty();const{data:a}=await r.sendActionRequest("POST","matrix-extended/nested-element-extended/paste-entry",{data:{fieldId:e.data().fieldId,entryId:e.data().id,entryTypeId:i,ownerId:t.settings.ownerId,ownerElementType:t.settings.ownerElementType,siteId:t.settings.ownerSiteId}});await this.addElementCard(a,t,e.data("id"))}catch{this.addStatusMessage(r.t("matrix-extended","There was an error pasting the entry"),"error")}s.data("disclosureMenu").hide()}},async addElementCard(s,n,i){var o,c,y,m;n.$createBtn&&n.$createBtn.addClass("loading");let e;try{e=await r.sendActionRequest("POST","app/render-elements",{data:{elements:[{type:n.elementType,id:s.id,ownerId:n.settings.ownerId,siteId:s.siteId,instances:[{context:"field",ui:"card",sortable:n.settings.sortable,showActionMenu:!0}]}]}})}catch(p){throw r.cp.displayError((c=(o=p==null?void 0:p.response)==null?void 0:o.data)==null?void 0:c.message),((m=(y=p==null?void 0:p.response)==null?void 0:y.data)==null?void 0:m.message)??p}finally{n.$createBtn&&n.$createBtn.removeClass("loading")}n.$elements||n.initCards();const t=d("<li/>"),a=d(e.data.elements[s.id][0]).appendTo(t);return n.$elements.find(`[data-id="${i}"`).parent().after(t),n.initElement(a),await r.appendHeadHtml(e.data.headHtml),await r.appendBodyHtml(e.data.bodyHtml),r.cp.elementThumbLoader.load(a),n.updateCreateBtn(),a},addStatusMessage:function(s,n="notice"){n==="notice"&&r.cp.displayNotice(s),n==="error"&&r.cp.displayError(s)}}))})(window);
//# sourceMappingURL=nestedElementExtendedJs-326ee424.js.map
