(function(M){const{Craft:c,Garnish:g,$:n}=M;!c||!g||!n||(c.MatrixExtended=g.Base.extend({settings:{},childParent:{},helper:void 0,itemDrag:void 0,init:function(s,i){const l=this;if(this.settings=s.settings||{},this.childParent=s.childParent||{},this.helper=i,!g.DisclosureMenu||!c.MatrixInput)return;const o=g.DisclosureMenu.prototype.show;g.DisclosureMenu.prototype.show=function(...t){l.initDisclosureMenu(this),o.apply(this,t)};const e=g.DisclosureMenu.prototype.init;g.DisclosureMenu.prototype.init=function(...t){e.apply(this,t),l.initAddButtonMenu(this),l.prepareEntryDropZones()};const f=c.MatrixInput.prototype.updateAddEntryBtn;if(c.MatrixInput.prototype.updateAddEntryBtn=function(...t){f.apply(this,t),l.checkAddBtn(this)},!this.settings.enableDragDrop)return;const r=c.MatrixInput.prototype.init;c.MatrixInput.prototype.init=function(...t){r.apply(this,t),this.entrySort.allowDragging=()=>!1,this.entrySort.destroy(),l.prepareEntryDropZones()},c.MatrixInput.prototype.canAddMoreEntries=function(){return!this.maxEntries||this.$entriesContainer.children(":not(.matrix-extended-drop-target):not(.matrix-extended-buttons)").length<this.maxEntries};const u=n(".matrix-field").find(".matrixblock");for(const t of u){const a=n(t);a.find("> .actions > .move-btn").remove(),a.find("> .actions").append('<div class="chromeless small move"><div class="inline-flex"><div class="cp-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" focusable="false" aria-hidden="true"><path d="M71.3 295.6c-21.9-21.9-21.9-57.3 0-79.2s57.3-21.9 79.2 0 21.9 57.3 0 79.2s-57.4 21.9-79.2 0zM184.4 182.5c-21.9-21.9-21.9-57.3 0-79.2s57.3-21.9 79.2 0 21.9 57.3 0 79.2-57.3 21.8-79.2 0zm0 147c21.9-21.9 57.3-21.9 79.2 0s21.9 57.3 0 79.2s-57.3 21.9-79.2 0c-21.9-21.8-21.9-57.3 0-79.2zM297.5 216.4c21.9-21.9 57.3-21.9 79.2 0s21.9 57.3 0 79.2s-57.3 21.9-79.2 0c-21.8-21.9-21.8-57.3 0-79.2z"></path></svg></div></div></div>')}this.itemDrag=new g.DragDrop({activeDropTargetClass:"active",minMouseDist:10,hideDraggee:!1,moveHelperToCursor:!0,handle:t=>n(t).find("> .actions > .move, > .titlebar"),filter:()=>this.itemDrag.$targetItem.closest(".matrixblock"),dropTargets:()=>{if(!this.childParent)return[];const{entry:t,typeId:a}=this.itemDrag.$draggee.closest(".matrixblock").data();return!t.matrix||!a?[]:n(".matrix-extended-drop-target").filter((h,x)=>(this.childParent[a]||[]).includes(n(x).data("entryTypeId"))).toArray().reverse()},onDragStart:()=>{g.$bod.addClass("dragging"),this.itemDrag.$draggee.closest(".matrixblock").addClass("draggee"),this.$dropEntry=this.itemDrag.$draggee.data("entry").$container,this.$pullBlock=this.$dropEntry.closest(".matrix-field")},onDragStop:async()=>{if(this.itemDrag.$draggee.closest(".matrixblock").removeClass("draggee"),g.$bod.removeClass("dragging"),!this.$dropEntry||!this.$pullBlock)return this.itemDrag.returnHelpersToDraggees();const t=this.$dropEntry,a=this.itemDrag.$activeDropTarget;if(!t||!a)return this.itemDrag.returnHelpersToDraggees();let m,d="insertBefore";a.data("position")==="button"?(m=a.closest(".matrix-field").find("> .blocks"),d="appendTo"):m=a.next(".matrixblock");const h=this.$pullBlock,x=a.closest(".matrix-field");if(h.is(x))d==="appendTo"?t.appendTo(m):t.insertBefore(m),h.data("matrix").entrySelect.resetItemOrder();else{const y=x.data("matrix"),b=h.data("matrix"),v=t.data("entry"),$=t.data("typeId");await this.duplicateWithNewOwner(m,d,$,v,y,b)}this.itemDrag.returnHelpersToDraggees(),this.prepareEntryDropZones(),this.$dropEntry=void 0,this.$pullBlock=void 0}})},prepareEntryDropZones(){var o,e;if(!this.settings.enableDragDrop)return;const s=n(".matrix-field"),i=s.find(".matrixblock");n(".matrix-extended-drop-target").remove();for(const f of i){const r=n(f);let p=null;const u=r.data("entry");if(!u)return;const t=u.matrix;if(!t)return;p=t.settings.fieldId;const a=n('<div class="matrix-extended-drop-target" data-position="block"><div></div></div>');a.data(r.data()),a.data("entryTypeId",p),r.before(a),t.updatePasteBtn(),c.cp.getCopiedElements().length||(o=t.$pasteBtn)==null||o.addClass("hidden")}const l=s.find("> .buttons");for(const f of l){const r=n(f),p=r.closest(".matrix-field").data("matrix");if(!p)continue;const u=n('<div class="matrix-extended-drop-target" data-position="button"><div></div></div>');u.data("entryTypeId",p.settings.fieldId),u.insertBefore(r),p.updatePasteBtn(),c.cp.getCopiedElements().length||(e=p.$pasteBtn)==null||e.addClass("hidden")}this.itemDrag.removeAllItems(),this.itemDrag.addItems(i),g.$bod.addClass("matrix-extended-drag-drop")},initAddButtonMenu(s){if(!this.settings.expandMenu)return;const{$trigger:i,$container:l}=s,o=i.parent(),f=i.closest(".buttons").parent(".matrix-field");if(!i||!l||!o.hasClass("buttons")||!f.attr("id")||i._hasMatrixExtensionButtonsInitialized)return;i.hide(),i._hasMatrixExtensionButtonsInitialized=!0;const r=n('<div class="buttons matrix-extended-buttons"></div>'),p=i.disclosureMenu().data("disclosureMenu").$container.find("button").clone().off().on("activate",async t=>{l.find("button").filter((m,d)=>n(d).data("type")===n(t.currentTarget).data("type")).trigger("activate")}),u=f.attr("id");this.buildGroupedMenu(r,p,i,u),r.appendTo(o)},initDisclosureMenu(s){const{$trigger:i,$container:l}=s;if(!i||!l||!i.hasClass("action-btn"))return;const o=i.closest(".actions").parent(".matrixblock");if(!o.length)return;const{typeId:e,entry:f}=o.data();if(!(!e||!f||!f.matrix)&&!s._hasMatrixExtensionButtonsInitialized&&(s._hasMatrixExtensionButtonsInitialized=!0,this.settings.removeEntryTypesFromDiscloseMenu)){const p=l.find('[data-action="add"]').parent().parent();p.prev().remove(),p.remove()}},duplicateWithNewOwner:async function(s,i,l,o,e,f){var r;if(!e.addingEntry){if(!e.canAddMoreEntries()){e.updateStatusMessage();return}e.addingEntry=!0,e.elementEditor&&await e.elementEditor.setFormValue(e.settings.baseInputName,"*");try{const p=e.elementEditor.getDraftElementId(o.id),{data:u}=await c.sendActionRequest("POST","matrix-extended/matrix-extended/duplicate-entry-with-new-owner",{data:{fieldId:e.settings.fieldId,entryId:p,entryTypeId:l,ownerId:e.settings.ownerId,ownerElementType:e.settings.ownerElementType,siteId:e.settings.siteId,namespace:e.settings.namespace,staticEntries:e.settings.staticEntries}}),t=n(u.blockHtml);(r=e.elementEditor)==null||r.pause(),i==="appendTo"?t.appendTo(s):t.insertBefore(s),o.$container.hide(),e.trigger("entryAdded",{$entry:t}),t.css("margin-bottom",""),c.initUiElements(t.children(".fields")),await c.appendHeadHtml(u.headHtml),await c.appendBodyHtml(u.bodyHtml),new c.MatrixInput.Entry(e,t),e.entrySort.addItems(t),e.entrySelect.addItems(t),e.updateAddEntryBtn(),t.css(e.getHiddenEntryCss(t)).velocity({opacity:1,"margin-bottom":10},"fast"),g.requestAnimationFrame(function(){var a;(a=e.elementEditor)==null||a.resume(),o.selfDestruct()})}catch{this.addStatusMessage(c.t("matrix-extended","There was an error dropping the entry"),"error")}e.addingEntry=!1,o.actionDisclosure.hide()}},buildGroupedMenu:function(s,i,l,o,e=!1){const f=o.replace(/.*fields-/,"");let r=i;if(!this.settings.fields){const d=n('<div class="btngroup matrix-extended-btngroup"></div>');r.first().addClass("add icon"),r.addClass("btn dashed"),d.append(r),s.append(d);return}if(!this.settings.fields[f]){const d=n('<div class="btngroup matrix-extended-btngroup"></div>');r.first().addClass("add icon"),r.addClass("btn dashed"),d.append(r),s.append(d);return}const p=this.settings.fields[f];p.oneLiner&&s.addClass("one-line");for(const[d,h]of Object.entries(p.groups)){n(`#matrix-extended-menu-${o}-${d}${e?"-above":""}`).remove();const x=c.ui.createButton({label:h.label,spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${o}-${d}${e?"-above":""}`).appendTo(s),y=n(`<div class="menu menu--disclosure" id="matrix-extended-menu-${o}-${d}${e?"-above":""}">`),b=n("<ul></ul>");y.append(b),n(document.body).append(y);const v=new g.DisclosureMenu(x);for(const $ of h.types){const I=n("<li></li>"),D=i.filter((B,E)=>n(E).data("type")===$);if(r=r.filter((B,E)=>n(E).data("type")!==$),!D.length){console.warn(`Type ${$} not found in group ${o}`);continue}I.append(D),b.append(I),D.on("activate",()=>{if(!e){v.hide();return}y.remove(),v.destroy()})}}if(!r.length)return;if(this.settings.expandUngrouped){const d=n('<div class="btngroup matrix-extended-btngroup"></div>');switch(r.first().addClass("add icon"),r.addClass("btn dashed"),d.append(r),this.settings.ungroupedPosition){case"start":s.prepend(d);break;case"end":s.append(d);break}return}n(`#matrix-extended-menu-${o}-others${e?"-above":""}`).remove();const u=c.ui.createButton({label:l.find(".label").text(),spinner:!0}).addClass("btn menubtn dashed add icon").attr("aria-controls",`matrix-extended-menu-${o}-others${e?"-above":""}`);switch(this.settings.ungroupedPosition){case"start":u.prependTo(s);break;case"end":u.appendTo(s);break}const t=n(`<div class="menu menu--disclosure" id="matrix-extended-menu-${o}-others${e?"-above":""}">`),a=n("<ul></ul>");t.append(a),n(document.body).append(t);const m=new g.DisclosureMenu(u);for(const d of r){const h=n("<li></li>"),x=n(d);h.append(x),a.append(h),x.on("activate",()=>{if(!e){m.hide();return}t.remove(),m.destroy()})}},checkAddBtn:function(s){if(!this.settings.expandMenu)return;const i=s.$container.find("> .blocks > .matrix-extended-buttons, > .buttons > .matrix-extended-buttons").find("button");i.disable();const l=i.parent();if(l.attr("title",""),!s.canAddMoreEntries()){l.attr("title",c.t("matrix-extended","No more entries can be added."));return}i.enable()},addStatusMessage:function(s,i="notice"){i==="notice"&&c.cp.displayNotice(s),i==="error"&&c.cp.displayError(s)}}))})(window);
//# sourceMappingURL=matrixExtendedJs-d4001fec.js.map
